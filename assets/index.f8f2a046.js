var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};function e(t,e){return t.reduce(((t,s)=>{let i="string"==typeof(o=s)||o instanceof String?s:s.name;var o;return i=i.replace(i[0],i[0].toLowerCase()),t[i]=e(i,s),t}),{})}const s=e(["onBackgroundColorChanged","onDrawCommitted","onForegroundColorChanged","onGlyphChanged","onTerminalResized","onTerminalResizeReady","onTerminalResizeVerify","onToolChanged"],((t,e)=>t));class i{register(...t){for(const e of t)e.subscribe(this)}subscribe(t,e){let s=this._notifications[t];s||(this._notifications[t]=s=[]),s.push(e)}signal(t){const e=this._notifications[t.event];if(e)for(const s of e)s(t)}constructor(){this._notifications={}}}const o={179:10,180:14,191:12,192:3,193:7,194:13,195:11,196:5,197:15,217:6,218:9},n={185:14,186:10,187:12,188:6,200:3,201:9,202:7,203:13,204:11,205:5,206:15},r={179:10,181:14,184:12,190:6,198:11,205:5,207:7,209:13,212:3,213:9,216:15},l={182:14,183:12,186:10,189:6,196:5,199:11,208:7,210:13,211:3,214:9,215:15};class h{getId(t){return this.bestFit[t]}hasAttractor(t,e){return Boolean(this.lines[t]&e)}constructor(t,e){this.lines=t,this.bestFit=e}}const d=new h(o,[196,196,179,192,196,196,217,193,179,218,179,195,191,194,180,197]),c=new h(n,[205,205,186,200,205,205,188,202,186,201,186,204,187,203,185,206]),a=new h(r,[205,205,179,212,205,205,190,207,179,213,179,198,184,209,181,216]),u=new h(l,[196,196,186,211,196,196,189,208,186,214,186,199,183,210,182,215]),_={NONE:0,RIGHT:1,TOP:2,LEFT:4,BOTTOM:8,complement:t=>t>2?t>>2:t<<2,rotate(t){switch(t){case _.RIGHT:case _.TOP:case _.LEFT:return t<<1;case _.BOTTOM:return _.RIGHT;default:return t}}};function g(t){return o[t]?d:n[t]?c:r[t]?a:l[t]?u:null}function p(t,e){var s;return Boolean(null===(s=g(t))||void 0===s?void 0:s.hasAttractor(t,e))}function f(t,e,s){const i=g(s);let o=null,n=null;switch(e){case _.TOP:case _.BOTTOM:o=a,n=u;break;case _.RIGHT:case _.LEFT:o=u,n=a}if(!o)return null;switch(t){case d:case o:switch(i){case d:case n:return d;case c:case o:return o}break;case c:case n:switch(i){case d:case n:return n;case c:case o:return c}}return null}const m=["␀","☺","☻","♥","♦","♣","♠","•","◘","○","◙","♂","♀","♪","♫","☼","►","◄","↕","‼","¶","§","▬","↨","↑","↓","→","←","∟","↔","▲","▼"," ","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\","]","^","_","`","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","{","|","}","~","⌂","Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","¢","£","¥","₧","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","⌐","¬","½","¼","¡","«","»","░","▒","▓","│","┤","╡","╢","╖","╕","╣","║","╗","╝","╜","╛","┐","└","┴","┬","├","─","┼","╞","╟","╚","╔","╩","╦","╠","═","╬","╧","╨","╤","╥","╙","╘","╒","╓","╫","╪","┘","┌","█","▄","▌","▐","▀","α","ß","Γ","π","Σ","σ","µ","τ","Φ","Θ","Ω","δ","∞","φ","ε","∩","≡","±","≥","≤","⌠","⌡","÷","≈","°","∙","·","√","ⁿ","²","■"," "];var y={*glyphs(){yield*m},*enumerate(){yield*m.entries()},glyph:t=>m[t],id:t=>m.indexOf(t),SIGILS:{DEFAULT:65,CLEAR:32,CURSOR:124,TRANSPARENT:255,NEWLINE:"\n"}};const C=function(){const t=[0,128,255],e=[];for(const s of t)for(const i of t)for(const o of t)e.push(`rgb(${s}, ${i}, ${o})`);return e}();var I={*cssColors(){yield*C},*enumerate(){yield*C.entries()},cssColor:t=>C[t],id:t=>(t.startsWith("#")&&(t=function(t){let e,s,i;if(3===t.length)[e,s,i]=t,e+=e,s+=s,i+=i;else{if(6!==t.length)return"";e=t.slice(0,2),s=t.slice(2,4),i=t.slice(4,6)}return`rgb(${parseInt(e,16)}, ${parseInt(s,16)}, ${parseInt(i,16)})`}(t.substring(1))),C.indexOf(t)),COLORS:{BLACK:0,WHITE:C.length-1}};class w{get glyphId(){return this._glyphId}set glyphId(t){this._glyphId=null!=t?t:y.SIGILS.CLEAR}get fgColorId(){return this._fgColorId}set fgColorId(t){this._fgColorId=null!=t?t:I.COLORS.BLACK}get bgColorId(){return this._bgColorId}set bgColorId(t){this._bgColorId=null!=t?t:I.COLORS.WHITE}isEmpty(){return this.glyphId===y.SIGILS.CLEAR}equals(t){return this.glyphId===t.glyphId&&this.fgColorId===t.fgColorId&&this.bgColorId===t.bgColorId}update({glyphId:t=this.glyphId,fgColorId:e=this.fgColorId,bgColorId:s=this.bgColorId}){this._setFields(t,e,s)}clone({glyphId:t=this.glyphId,fgColorId:e=this.fgColorId,bgColorId:s=this.bgColorId}={}){return new w(t,e,s)}_setFields(t,e,s){this.glyphId=t,this.fgColorId=e,this.bgColorId=s}constructor(t,e,s){this._setFields(t,e,s)}}function b(t,e,s){return{x:t,y:e,cell:s}}function v(t){return t.x<<16^t.y}function*x(t,e){const{x:s,y:i}=t,o=s-1,n=i-1,r=s+1,l=i+1;n>=0&&(yield{x:s,y:n,direction:_.TOP}),r<e.width&&(yield{x:r,y:i,direction:_.RIGHT}),l<e.height&&(yield{x:s,y:l,direction:_.BOTTOM}),o>=0&&(yield{x:o,y:i,direction:_.LEFT})}function S(t,e,s,i){const[o,n]=t.y<e.y?[t.y,e.y]:[e.y,t.y],[r,l]=t.x<e.x?[t.x,e.x]:[e.x,t.x];return i(o,l,n,r,s)}function T(t,e,s,i,o){const n=new G;for(let r=i;r<=e;++r)n.add(b(r,t,o)),n.add(b(r,s,o));for(let r=t+1;r<s;++r)n.add(b(i,r,o)),n.add(b(e,r,o));return n}function E(t,e,s,i,o){const n=[];for(let r=t;r<=s;++r)for(let t=i;t<=e;++t)n.push(b(t,r,o));return n}function k(t,e,s,i,o){const n=Math.abs(e.x-t.x),r=Math.abs(e.y-t.y),l=new G;if(n||r)if(n)if(r)!function(t,e,s){const i=t**2,o=e**2,n=2*i,r=2*o;let l=t,h=0,d=0,c=o*(1-2*t),a=i,u=r*t,_=0;for(;u>=_;)s(l,h++),_+=n,d+=a,a+=n,2*d+c>0&&(--l,u-=r,d+=c,c+=r);const g=l,p=h;l=0,h=e,d=0,c=o,a=i*(1-2*e),u=0,_=n*e;for(;u<=_;)s(l++,h),u+=r,d+=c,c+=r,2*d+a>0&&(--h,_-=n,d+=a,a+=n);for(;h>=p;)s(l-1,h--);for(;l<=g;)s(l++,h)}(n,r,((e,n)=>o(e,n,t,s.width,s.height,l,i)));else for(let e=0;e<=n;++e){const o=t.x+e,n=t.x-e;o<s.width&&l.add(b(o,t.y,i)),n>=0&&l.add(b(n,t.y,i))}else for(let e=0;e<=r;++e){const o=t.y+e,n=t.y-e;o<s.height&&l.add(b(t.x,o,i)),n>=0&&l.add(b(t.x,n,i))}else l.add(b(t.x,t.y,i));return l}function R(t,e,s,i,o,n,r){const l=s.x+t,h=s.x-t,d=s.y+e,c=s.y-e;l<i&&d<o&&n.add(b(l,d,r)),h>=0&&d<o&&n.add(b(h,d,r)),l<i&&c>=0&&n.add(b(l,c,r)),h>=0&&c>=0&&n.add(b(h,c,r))}function O(t,e,s,i,o,n,r){const l=Math.min(s.x+t,i-1),h=Math.max(0,s.x-t),d=Math.min(s.y+e,o-1),c=Math.max(0,s.y-e);for(let t=l;t>=s.x;--t)n.add(b(t,d,r)),n.add(b(t,c,r));for(let t=h;t<s.x;++t)n.add(b(t,d,r)),n.add(b(t,c,r))}var z=Symbol.iterator;class F{get length(){return this._tiles.length}add(t){this._tiles.push(t)}*[z](){yield*this._tiles}_find(t){return this._findin(t,this._tiles)}_findin(t,e){return e.find((e=>e.x===t.x&&e.y===t.y))}constructor(){this._tiles=[]}}class G extends F{add(t){const e=v(t);this._points.has(e)||this._insert(t,e)}_insert(t,e){super.add(t),this._points.add(e)}constructor(){super(),this._points=new Set}}class L extends G{constructor(t,e){super(),this.terminal=t,this.lineSet=e}}class B extends L{solve(){for(const t of this._tiles){let e=0,s=this.lineSet;for(const i of x(t,this.terminal.dimensions))[e,s]=this._solveNeighborConstraints(i,e,s);t.cell.glyphId=s.getId(e)}}_solveNeighborConstraints(t,e,s){var i;const o=this._find(t),n=null!==(i=null==o?void 0:o.cell)&&void 0!==i?i:this.terminal.getCell(t.x,t.y);return p(n.glyphId,_.complement(t.direction))&&(e|=t.direction,o||(s=f(this.lineSet,_.rotate(t.direction),n.glyphId))),[e,s]}}class N extends L{add(t){t=this._resolveTile(t);const e=[];let s=0;for(const i of x(t,this.terminal.dimensions))s=this._processNeighbor(i,s,e),t.cell.glyphId=this.lineSet.getId(s);for(const t of e)super.add(t)}_resolveTile(t){const e=v(t);if(this._points.has(e)){const e=this._find(t);e.cell.update({fgColorId:t.cell.fgColorId,bgColorId:t.cell.bgColorId}),t=e}else t.cell=t.cell.clone({glyphId:this.lineSet.getId(_.RIGHT|_.LEFT)}),this._insert(t,e);return t}_processNeighbor(t,e,s){var i;let o=null!==(i=this._find(t))&&void 0!==i?i:this._findin(t,s);var n;const r=null!==(n=null==o?void 0:o.cell)&&void 0!==n?n:this.terminal.getCell(t.x,t.y),l=o?this.lineSet:f(this.lineSet,t.direction,r.glyphId);if(l){if(e|=t.direction,!o){const e=r.clone({glyphId:l.getId(_.RIGHT|_.LEFT)});o=b(t.x,t.y,e),s.push(o)}let i=_.complement(t.direction);for(const t of x(o,this.terminal.dimensions))i=this._processNeighborOfNeighbor(t,i,s);o.cell.glyphId=l.getId(i)}return e}_processNeighborOfNeighbor(t,e,s){var i,o;const n=null!==(i=this._find(t))&&void 0!==i?i:this._findin(t,s);return p((null!==(o=null==n?void 0:n.cell)&&void 0!==o?o:this.terminal.getCell(t.x,t.y)).glyphId,_.complement(t.direction))&&(e|=t.direction),e}}var M=Symbol.iterator;class A extends F{advance(t,e){const s=new w(e,this._fgColor,this._bgColor);this.add(b(t.x,t.y,s))}newline(t){this.add(b(t.x,t.y,y.SIGILS.NEWLINE))}reverse(){return this._tiles.pop()}*[M](){yield*this._tiles.filter((t=>t.cell!==y.SIGILS.NEWLINE))}constructor(t){super(),this._fgColor=t.fgColorId,this._bgColor=t.bgColorId,this.cursorOn=new w(y.SIGILS.CURSOR,this._fgColor,this._bgColor),this.cursorOff=new w(y.SIGILS.TRANSPARENT,this._fgColor,this._bgColor)}}function H(t,e,s,i){return null!=i?i:[b(e.x,e.y,t)]}function D(t,e,s,i){return(i=null!=i?i:new G).add(b(s.x,s.y,t)),i}function P(t,e,s,i,o){const n=g(t.glyphId);return(i=null!=i?i:n?new N(o,n):new G).add(b(s.x,s.y,t)),i}function V(t,e,s,i,o){if(i)return i;const n=new Set([v(e)]),r=[e],l=[b(e.x,e.y,t)],h=o.getCell(e.x,e.y);for(;r.length>0;){const e=r.shift();for(const s of x(e,o.dimensions)){const e=v(s);if(n.has(e))continue;n.add(e);o.getCell(s.x,s.y).equals(h)&&(l.push(b(s.x,s.y,t)),r.push(s))}}return l}function $(t,e,s){return S(e,s,t,T)}function W(t,e,s){return S(e,s,t,E)}function U(t,e,s,i,o){const n=g(t.glyphId);return S(e,s,t,n?(...t)=>function(t,e,s,i,o,n,r){const l=new B(t,e);for(let t=n;t<=i;++t)t===n?(l.add(b(t,s,r.clone({glyphId:e.getId(_.RIGHT|_.DOWN)}))),l.add(b(t,o,r.clone({glyphId:e.getId(_.TOP|_.RIGHT)})))):t===i?(l.add(b(t,s,r.clone({glyphId:e.getId(_.BOTTOM|_.LEFT)}))),l.add(b(t,o,r.clone({glyphId:e.getId(_.TOP|_.LEFT)})))):(l.add(b(t,s,r.clone({glyphId:e.getId(_.RIGHT|_.LEFT)}))),l.add(b(t,o,r.clone({glyphId:e.getId(_.RIGHT|_.LEFT)}))));for(let t=s+1;t<o;++t)l.add(b(n,t,r.clone({glyphId:e.getId(_.TOP|_.BOTTOM)}))),l.add(b(i,t,r.clone({glyphId:e.getId(_.TOP|_.BOTTOM)})));return l.solve(),l}(o,n,...t):T)}function j(t,e,s,i,o){return k(e,s,o.dimensions,t,R)}function K(t,e,s,i,o){return k(e,s,o.dimensions,t,O)}function q(t,e,s){return function(t,e,s,i,o){const n=Math.abs(s-t),r=-Math.abs(i-e),l=t<s?1:-1,h=e<i?1:-1,d=new G;let c=n+r;for(;d.add(b(t,e,o)),t!==s||e!==i;){const s=2*c;s>=r&&(c+=r,t+=l),s<=n&&(c+=n,e+=h)}return d}(e.x,e.y,s.x,s.y,t)}function J(t,e,s,i){return null!=i?i:new A(t)}function Q(t,e,s,i,o){if(i)return i;const n=o.getCell(e.x,e.y),r=[];if(n.equals(t))return r;const{width:l,height:h}=o.dimensions;for(let e=0;e<h;++e)for(let s=0;s<l;++s){o.getCell(s,e).equals(n)&&r.push(b(s,e,t))}return r}function X(t){return{x:parseInt(t.dataset.x,10),y:parseInt(t.dataset.y,10)}}class Y{get position(){return this._position}set(t){clearInterval(this._timer),this._start(t)}reset(t){this._on=!1,clearInterval(this._timer),this.restore(this.position),t&&this._start(t)}clear(){clearInterval(this._timer)}_start(t){this._on=!0,this._position={...t},this._toggle(),this._timer=setInterval(this._toggle.bind(this),600)}_toggle(){this.draw(this.position.x,this.position.y,this._on?this.onState:this.offState),this._on=!this._on}constructor(t,e,s,i){this.onState=t,this.offState=e,this.draw=s,this.restore=i,this._on=!1}}class Z{handleEvent(t){const e=`on${t.type.replace(t.type[0],t.type[0].toUpperCase())}`;return this[e]?this[e](t):null}constructor(t,e,s){this.updateFigure=t,this.sketchpad=e,this.terminal=s,this._started=!1}}class tt extends Z{_drawFigure(){const t=new Set,e=[];for(const{x:s,y:i,cell:o}of this._activeFigure){this.sketchpad.updateAt(s,i,o);const n={x:s,y:i};t.add(v(n)),e.push(n)}for(const e of this._prevDrawTiles)if(!t.has(v(e))){const{x:t,y:s}=e,i=this.terminal.getCell(t,s);this.sketchpad.updateAt(t,s,i)}this._prevDrawTiles=e}constructor(...t){super(...t),this._prevDrawTiles=[]}}class et extends tt{onMousedown(t){return this._started=!0,this._start=this._end=X(t.target),this._activeFigure=this.updateFigure(this._start,this._end,this._activeFigure,this.terminal),this._drawFigure(),null}onMouseover(t){return this._started?(this._end=X(t.target),this._activeFigure=this.updateFigure(this._start,this._end,this._activeFigure,this.terminal),this._drawFigure(),null):null}onMouseup(t){return this._activeFigure}}class st extends tt{onMousedown(t){return this._started?this.cleanup():(this._started=!0,this._dimensions=this.terminal.dimensions,this._activeFigure=this.updateFigure(),this._start=this._end=X(t.target),this._cursor=new Y(this._activeFigure.cursorOn,this._activeFigure.cursorOff,this._drawCursor.bind(this),this._restoreCell.bind(this)),this._cursor.set(this._start),console.log("START CURSOR POS: %o",this._start),null)}onKeydown(t){if(!this._started||t.altKey||t.ctrlKey||t.metaKey)return null;switch(t.preventDefault(),t.key){case"Backspace":this._reverseCharacter();break;case"Enter":this._newline();break;case"Escape":return this.cleanup();case" ":this._advanceCharacter(this._cursor.offState.glyphId);break;default:this._advanceCharacter(y.id(t.key))}return null}cleanup(){return this._started?(this._cursor.reset(),this._activeFigure):null}get _isValidPosition(){return this._end.y>=0&&this._end.y<this._dimensions.height}_advanceCharacter(t){!this._isValidPosition||t<0||(this._activeFigure.advance(this._end,t),this._advanceCursor(),this._drawFigure())}_advanceCursor(){let{x:t,y:e}=this._end;++t,t>=this._dimensions.width&&(t=0,++e),this._end={x:t,y:e},e<this._dimensions.height?this._cursor.set(this._end):this._cursor.clear(),console.log("NEW CURSOR POS: %o",this._end)}_reverseCharacter(){const t=this._activeFigure.reverse();t&&(this._end={x:t.x,y:t.y},this._cursor.reset(this._end)),console.log("REVERSE CURSOR POS: %o",this._end)}_newline(){this._activeFigure.newline(this._end);let t=this._end.y+1;t<this._dimensions.height&&(this._end={x:this._start.x,y:t},this._cursor.reset(this._end)),console.log("NL CURSOR POS: %o",this._end)}_drawCursor(t,e,s){this.sketchpad.updateAt(t,e,s)}_restoreCell(t){const e=this.terminal.getCell(t.x,t.y);this.sketchpad.updateAt(t.x,t.y,e)}}class it extends Z{onMouseup(t){this._started=!0,t.stopPropagation();const e=X(t.target);return Number.isNaN(e.x)||Number.isNaN(e.y)||this.sketchpad.commitCellSampling(this.terminal.getCell(e.x,e.y)),this.updateFigure()}}class ot{forward(t,e){return this._gesture||(this._gesture=this._createGesture(t)),this._gesture.handleEvent(e)}committed(t){this._gesture=null}cleanup(t){return this.committed(t),null}_createGesture(t){return new this.gestureCls(((t,e,s,i)=>this.figure(this.models.lettertype.cell,t,e,s,i)),t,this.models.terminal)}constructor(t,e,s){this.models=t,this.gestureCls=e,this.figure=s}}class nt extends ot{forward(t,e){const s=super.forward(t,e);return s&&(this._pendingGesture=this._createGesture(t),this._pendingGesture.handleEvent(e)),s}committed(t){this._gesture=this._pendingGesture,this._pendingGesture=null}cleanup(t){const e=this._gesture.cleanup();return this._gesture=this._pendingGesture=null,e}constructor(t){super(t,st,J)}}class rt extends ot{constructor(t){super(t,it,(()=>[]))}}const lt={point:t=>new ot(t,et,H),brush:t=>new ot(t,et,D),boxBrush:t=>new ot(t,et,P),fill:t=>new ot(t,et,V),rect:t=>new ot(t,et,$),fillRect:t=>new ot(t,et,W),boxRect:t=>new ot(t,et,U),ellipse:t=>new ot(t,et,j),fillEllipse:t=>new ot(t,et,K),line:t=>new ot(t,et,q),text:t=>new nt(t),swap:t=>new ot(t,et,Q),eyedrop:t=>new rt(t)},ht=e(Object.values(lt),((t,e)=>t));function dt(t){const e=lt[t.currentTool];if(!e)throw new Error(`Unknown tool: ${t.currentTool}`);return e(t)}function ct(t,e){return{event:t,...e}}const at={commitDraw:(t,e,i=!1)=>()=>(t.terminal.update(e),ct(s.onDrawCommitted,{figure:e,cleanup:i})),checkResizeTerminal:(t,e)=>()=>{const i=t.terminal.dimensions;return ct(e.columns<i.width||e.rows<i.height?s.onTerminalResizeVerify:s.onTerminalResizeReady,{dims:e})},commitResizeTerminal:(t,e)=>()=>(console.log("resized terminal: %o",e),t.terminal.resize(e.columns,e.rows),t.lettertype.fontSize=e.fontSize,ct(s.onTerminalResized,{terminal:t.terminal,fontSize:e.fontSize})),setBackgroundColor:(t,e)=>()=>(t.lettertype.cell.bgColorId=e,ct(s.onBackgroundColorChanged,{colorId:e})),setForegroundColor:(t,e)=>()=>(t.lettertype.cell.fgColorId=e,ct(s.onForegroundColorChanged,{colorId:e})),setGlyph:(t,e)=>()=>(t.lettertype.cell.glyphId=e,ct(s.onGlyphChanged,{glyphId:e})),setTool:(t,e)=>()=>(t.currentTool=e,ct(s.onToolChanged,{tool:dt(t),name:e}))},ut=e(Object.values(at),((t,e)=>t));class _t{command(t,...e){const s=this._commands[t];if(!s)throw new Error(`Unknown command: ${t}`);const i=s(...e)();this.notifier.signal(i)}_bindCommands(t){this._commands=e(Object.values(at),((e,s)=>(...e)=>s(t,...e)))}constructor(t,e){this.notifier=t,this._bindCommands(e)}}class gt{get dimensions(){return{width:this._stride,height:this._height}}resize(t,e){if(t<1||t>65536||e<1||e>65536){throw new Error(`Terminal dimensions must be in range [1, 65536]; got arguments {columns: ${t}, rows: ${e}}`)}if(t===this._stride&&e===this._height)return;const s=this._newCellGrid(t,e);this._stride=t,this._height=e,this._cells=s}getCell(t,e){const s=t+e*this._stride;return this._cells[s]}updateCell(t,e,s){this.getCell(t,e).update(s)}update(t){for(const{x:e,y:s,cell:i}of t)this.updateCell(e,s,i)}_newCellGrid(t,e){const s=[],i=Math.trunc((this._stride-t)/2),o=Math.trunc((this._height-e)/2);for(let n=0;n<e;++n)for(let e=0;e<t;++e){const t=e+i,r=n+o,l=this._getResizeAdjustedCell(t,r);s.push(l||new w)}return s}_getResizeAdjustedCell(t,e){return t>=0&&t<this._stride&&e>=0&&e<this._height?this.getCell(t,e):null}constructor(t,e){this._stride=this._height=0,this.resize(t,e)}}var pt={load:()=>({currentTool:ht.brush,lettertype:{cell:new w(y.SIGILS.DEFAULT),fontSize:24},terminal:new gt(50,20)})};class ft{constructor(t,e){this.doc=t,this.dispatch=e}}class mt extends ft{draw(t){this._setColor(this.colorInitializer(t.colors)),this._selection.addEventListener("click",(t=>this.onSelected(this)))}subscribe(t){t.subscribe(this.refreshEvent,this._refreshColor.bind(this))}select(){this._selection.classList.add("selected")}deselect(){this._selection.classList.remove("selected")}pick(t){this.dispatch.command(this.cmd,t)}_refreshColor(t){this._setColor(t.colorId)}_setColor(t){this._selection.style.backgroundColor=I.cssColor(t)}constructor(t,e,s,i,o,...n){super(...n),this._selection=this.doc.getElementById(t),this.cmd=e,this.refreshEvent=s,this.onSelected=i,this.colorInitializer=o}}class yt extends ft{get fontSize(){return parseInt(this._inputControls[0].value,10)}get columns(){return parseInt(this._inputControls[1].value,10)}get rows(){return parseInt(this._inputControls[2].value,10)}draw(t){const e=t.terminal.dimensions;[t.fontSize,e.width,e.height].forEach(((t,e)=>{const s=this._inputControls[e];s.dataset.currentValue=s.value=t}));for(const t of this._inputControls)t.addEventListener("input",this._updateButton.bind(this));this._form.addEventListener("submit",this._updateSketchpadDims.bind(this))}subscribe(t){t.subscribe(s.onTerminalResizeVerify,this._verifyResize.bind(this)),t.subscribe(s.onTerminalResizeReady,this._commitResize.bind(this))}_updateSketchpadDims(t){t.preventDefault();const e={fontSize:this.fontSize,columns:this.columns,rows:this.rows};this.dispatch.command(ut.checkResizeTerminal,e)}_verifyResize(t){if(this.doc.defaultView.confirm("Reducing the drawing size may discard portions of your current sketch. Continue?"))this._commitResize(t);else{for(const t of this._inputControls)t.value=t.dataset.currentValue;this._updateButton()}}_commitResize(t){for(const t of this._inputControls)t.dataset.currentValue=t.value;this._updateButton(),this.dispatch.command(ut.commitResizeTerminal,t.dims)}_updateButton(){this._button.disabled=this._inputControls.every((t=>t.value===t.dataset.currentValue))}constructor(...t){super(...t),this._form=this.doc.getElementById("sketchpad-controls"),this._button=this._form.querySelector("button"),this._inputControls=[this.doc.getElementById("font-size"),this.doc.getElementById("column-count"),this.doc.getElementById("row-count")]}}const Ct=[class extends ft{draw(t){for(const[t,e]of I.enumerate()){const s=this.doc.createElement("div");s.className="palette-cell",s.dataset.id=t,s.style.backgroundColor=e,s.addEventListener("click",this._pickColor.bind(this)),this._palette.appendChild(s)}for(const e of this._colorSelections)e.draw(t);this._setSelection(this._colorSelections[0])}subscribe(t){for(const e of this._colorSelections)e.subscribe(t)}_setSelection(t){for(const t of this._colorSelections)t.deselect();t.select(),this._currentSelection=t}_pickColor(t){const e=parseInt(t.target.dataset.id,10);this._currentSelection.pick(e)}constructor(...t){super(...t),this._palette=this.doc.getElementById("palette");const e=this._setSelection.bind(this);this._colorSelections=[new mt("foreground-selection",ut.setForegroundColor,s.onForegroundColorChanged,e,(t=>t.fg),...t),new mt("background-selection",ut.setBackgroundColor,s.onBackgroundColorChanged,e,(t=>t.bg),...t)]}},class extends ft{draw(t){for(const[e,s]of y.enumerate()){const i=this.doc.createElement("span");i.dataset.id=e,i.textContent=s;const o=this.doc.createElement("div");o.appendChild(i),e===t.glyphId&&(o.className="selected"),o.addEventListener("click",this._pickGlyph.bind(this)),this._block.appendChild(o)}}subscribe(t){t.subscribe(s.onGlyphChanged,this._refreshGlyph.bind(this))}_refreshGlyph(t){const e=t.glyphId;for(const t of this._block.children)t.className=t.firstElementChild.dataset.id===e.toString()?"selected":""}_pickGlyph(t){const e=parseInt(t.target.firstElementChild.dataset.id,10);this.dispatch.command(ut.setGlyph,e)}constructor(...t){super(...t),this._block=this.doc.getElementById("letter-block")}},class extends ft{draw(t){this._controls.draw(t),this._tool=t.tool,this._drawSketchpad(t.terminal,t.fontSize),this.doc.addEventListener("mouseup",this._handleGesture.bind(this)),this.doc.addEventListener("keydown",this._handleGesture.bind(this))}subscribe(t){this._controls.subscribe(t),t.subscribe(s.onDrawCommitted,this._committed.bind(this)),t.subscribe(s.onToolChanged,this._updateTool.bind(this)),t.subscribe(s.onTerminalResized,this._resizeSketchpad.bind(this))}updateAt(t,e,s){const i=t+e*this._stride,o=this._grid[i];if(!o)return void console.warn("Invalid grid index %d: (%d, %d)",i,t,e);const n=o.firstChild;n.textContent=y.glyph(s.glyphId),n.style.color=I.cssColor(s.fgColorId),n.style.backgroundColor=I.cssColor(s.bgColorId)}commitCellSampling(t){this.dispatch.command(ut.setForegroundColor,t.fgColorId),this.dispatch.command(ut.setBackgroundColor,t.bgColorId),this.dispatch.command(ut.setGlyph,t.glyphId)}_drawSketchpad(t,e){const s=this._measureGlyph(e),i=t.dimensions;this._stride=i.width,console.log("Tilesize: %o",s),console.log("TermSize: %o",i);const o=this._sketchpad.style;o.fontSize=`${e}px`,o.width=i.width*s.width+"px",o.height=i.height*s.height+"px",o.gridTemplateColumns=`repeat(${i.width}, 1fr)`;const n=`${s.width}px`,r=`${s.height}px`,l=["mousedown","mouseover","mouseup"];for(this._grid.length=0;this._sketchpad.firstChild;)this._sketchpad.removeChild(this._sketchpad.firstChild);for(let e=0;e<i.height;++e)for(let s=0;s<i.width;++s){const i=this.doc.createElement("div");i.appendChild(this.doc.createElement("span")),i.style.width=n,i.style.height=r,i.dataset.x=s,i.dataset.y=e;for(const t of l)i.addEventListener(t,this._handleGesture.bind(this));this._grid.push(i),this._sketchpad.appendChild(i),this.updateAt(s,e,t.getCell(s,e))}}_measureGlyph(t){this._ruler.style.fontSize=`${t}px`;let e={minWidth:100,maxWidth:0,minHeight:100,maxHeight:0};e=[...y.glyphs()].reduce(((t,e)=>{this._ruler.textContent=e;const{width:s,height:i}=this._ruler.getBoundingClientRect();return{minWidth:Math.min(t.minWidth,s||t.minWidth),maxWidth:Math.max(t.maxWidth,s),minHeight:Math.min(t.minHeight,i||t.minHeight),maxHeight:Math.max(t.maxHeight,i)}}),e),this._ruler.textContent=y.glyph(y.SIGILS.DEFAULT);const{width:s,height:i}=this._ruler.getBoundingClientRect();return console.log("Font dims: %o",e),console.log("Bounding rect: %o",{width:s,height:i}),{width:Math.round(s),height:Math.round(i)}}_handleGesture(t){const e=this._tool.forward(this,t);e&&(this.dispatch.command(ut.commitDraw,e),console.log("generated figure: %o",e))}_committed(t){t.cleanup||(console.log("commit figure"),this._tool.committed(t))}_updateTool(t){const e=this._tool.cleanup();e&&(this.dispatch.command(ut.commitDraw,e,!0),console.log("got cleanup figure: %o",e)),this._tool=t.tool}_resizeSketchpad(t){this._drawSketchpad(t.terminal,t.fontSize)}constructor(...t){super(...t),this._controls=new yt(...t),this._ruler=this.doc.getElementById("glyph-ruler"),this._sketchpad=this.doc.getElementById("sketchpad"),this._grid=[],this._stride=0}},class extends ft{draw(t){for(const e of Object.values(ht)){const s=this.doc.createElement("input");s.type="radio",s.id=`tool-selection-${e}`,s.name="tool-selection",s.value=e,s.checked=e===t.toolName,s.addEventListener("input",this._pickTool.bind(this));const i=this.doc.createElement("label");i.htmlFor=s.id,i.innerText=e,this._toolSelector.appendChild(s),this._toolSelector.appendChild(i),this._toolSelections.push(s)}}subscribe(t){t.subscribe(s.onToolChanged,this._refreshTool.bind(this))}_pickTool(t){this.dispatch.command(ut.setTool,t.target.value)}_refreshTool(t){for(const e of this._toolSelections)e.checked=e.value===t.name}constructor(...t){super(...t),this._toolSelector=this.doc.getElementById("tool-selections"),this._toolSelections=[]}}];class It{initialize(){this._createModels(),this._wireCommands(),this._createViews(),this._registerViews(),this._drawViews(),console.log("started letter-sketch")}_createModels(){this._models=pt.load()}_wireCommands(){this._dispatch=new _t(this._notifier,this._models)}_createViews(){this._views=Ct.map((t=>new t(this._doc,this._dispatch)))}_registerViews(){this._notifier.register(...this._views)}_drawViews(){const t=this._initialState();for(const e of this._views)e.draw(t)}_initialState(){return{colors:{bg:this._models.lettertype.cell.bgColorId,fg:this._models.lettertype.cell.fgColorId},fontSize:this._models.lettertype.fontSize,glyphId:this._models.lettertype.cell.glyphId,terminal:this._models.terminal,tool:dt(this._models),toolName:this._models.currentTool}}constructor(t){this.win=t,this._doc=t.document,this._notifier=new i,this._models={}}}t.lettersketch=function(){let t;return{start(e){t=new It(e),t.initialize()}}}();
//# sourceMappingURL=index.f8f2a046.js.map
