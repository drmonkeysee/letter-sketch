let e;var t="u">typeof globalThis?globalThis:"u">typeof self?self:"u">typeof window?window:"u">typeof global?global:{};let i=Object.fromEntries(["onBackgroundColorChanged","onDrawCommitted","onForegroundColorChanged","onGlyphChanged","onTerminalResized","onTerminalResizeReady","onTerminalResizeVerify","onToolChanged"].map(e=>[e,e]));class s{constructor(){this._notifications={}}register(...e){for(let t of e)t.subscribe(this)}subscribe(e,t){let i=this._notifications[e];i||(this._notifications[e]=i=[]),i.push(t)}signal(e){let t=this._notifications[e.event];if(t)for(let i of t)i(e)}}let r={179:10,180:14,191:12,192:3,193:7,194:13,195:11,196:5,197:15,217:6,218:9},l={185:14,186:10,187:12,188:6,200:3,201:9,202:7,203:13,204:11,205:5,206:15},o={179:10,181:14,184:12,190:6,198:11,205:5,207:7,209:13,212:3,213:9,216:15},n={182:14,183:12,186:10,189:6,196:5,199:11,208:7,210:13,211:3,214:9,215:15};class h{constructor(e,t){this.lines=e,this.bestFit=t}getId(e){return this.bestFit[e]}hasAttractor(e,t){return!!(this.lines[e]&t)}}let d=new h(r,[196,196,179,192,196,196,217,193,179,218,179,195,191,194,180,197]),a=new h(l,[205,205,186,200,205,205,188,202,186,201,186,204,187,203,185,206]),c=new h(o,[205,205,179,212,205,205,190,207,179,213,179,198,184,209,181,216]),u=new h(n,[196,196,186,211,196,196,189,208,186,214,186,199,183,210,182,215]),_={NONE:0,RIGHT:1,TOP:2,LEFT:4,BOTTOM:8,complement:e=>e>2?e>>2:e<<2,rotate(e){switch(e){case _.RIGHT:case _.TOP:case _.LEFT:return e<<1;case _.BOTTOM:return _.RIGHT;default:return e}}};function g(e){return r[e]?d:l[e]?a:o[e]?c:n[e]?u:null}function p(e,t){return!!g(e)?.hasAttractor(e,t)}function m(e,t,i){let s=g(i),r=null,l=null;switch(t){case _.TOP:case _.BOTTOM:r=c,l=u;break;case _.RIGHT:case _.LEFT:r=u,l=c}if(!r)return null;switch(e){case d:case r:switch(s){case d:case l:return d;case a:case r:return r}break;case a:case l:switch(s){case d:case l:return l;case a:case r:return a}}return null}let f=Number.parseInt(Object.keys(r)[0],10),y=["␀","☺","☻","♥","♦","♣","♠","•","◘","○","◙","♂","♀","♪","♫","☼","►","◄","↕","‼","¶","§","▬","↨","↑","↓","→","←","∟","↔","▲","▼"," ","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\","]","^","_","`","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","{","|","}","~","⌂","Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","¢","£","¥","₧","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","⌐","¬","½","¼","¡","«","»","░","▒","▓","│","┤","╡","╢","╖","╕","╣","║","╗","╝","╜","╛","┐","└","┴","┬","├","─","┼","╞","╟","╚","╔","╩","╦","╠","═","╬","╧","╨","╤","╥","╙","╘","╒","╓","╫","╪","┘","┌","█","▄","▌","▐","▀","α","ß","Γ","π","Σ","σ","µ","τ","Φ","Θ","Ω","δ","∞","φ","ε","∩","≡","±","≥","≤","⌠","⌡","÷","≈","°","∙","·","√","ⁿ","²","■"," "];var C={*glyphs(){yield*y},*enumerate(){yield*y.entries()},glyph:e=>y[e],id:e=>y.indexOf(e),SIGILS:{DEFAULT:65,CLEAR:32,CURSOR:124,TRANSPARENT:255,NEWLINE:"\n"}};function I(e){let t,i,s;if(3===e.length)[t,i,s]=e,t+=t,i+=i,s+=s;else{if(6!==e.length)return"";t=e.slice(0,2),i=e.slice(2,4),s=e.slice(4,6)}return`rgb(${parseInt(t,16)}, ${parseInt(i,16)}, ${parseInt(s,16)})`}let[b,w]=[Object.keys(e={White:I("ffffff"),Silver:I("c0c0c0"),Gray:I("808080"),Black:I("000000"),Red:I("ff0000"),Maroon:I("800000"),Yellow:I("ffff00"),Olive:I("808000"),Lime:I("00ff00"),Green:I("008000"),Aqua:I("00ffff"),Teal:I("008080"),Blue:I("0000ff"),Navy:I("000080"),Fuchsia:I("ff00ff"),Purple:I("800080")}),Object.values(e)];var x={*cssColors(){yield*w},*enumerate(){yield*w.entries()},cssColor:e=>w[e],name:e=>b[e],id:e=>(e.startsWith("#")&&(e=I(e.substring(1))),w.indexOf(e)),COLORS:{BLACK:b.indexOf("Black"),WHITE:b.indexOf("White")}};class S{constructor(e,t,i){this._setFields(e,t,i)}get glyphId(){return this._glyphId}set glyphId(e){this._glyphId=e??C.SIGILS.CLEAR}get fgColorId(){return this._fgColorId}set fgColorId(e){this._fgColorId=e??x.COLORS.BLACK}get bgColorId(){return this._bgColorId}set bgColorId(e){this._bgColorId=e??x.COLORS.WHITE}isEmpty(){return this.glyphId===C.SIGILS.CLEAR}equals(e){return this.glyphId===e.glyphId&&this.fgColorId===e.fgColorId&&this.bgColorId===e.bgColorId}update({glyphId:e=this.glyphId,fgColorId:t=this.fgColorId,bgColorId:i=this.bgColorId}){this._setFields(e,t,i)}clone({glyphId:e=this.glyphId,fgColorId:t=this.fgColorId,bgColorId:i=this.bgColorId}={}){return new S(e,t,i)}_setFields(e,t,i){this.glyphId=e,this.fgColorId=t,this.bgColorId=i}}function T(e,t,i){return{x:e,y:t,cell:i}}function v(e){return e.x<<16^e.y}function*k(e,t){let{x:i,y:s}=e,r=i-1,l=s-1,o=i+1,n=s+1;l>=0&&(yield{x:i,y:l,direction:_.TOP}),o<t.width&&(yield{x:o,y:s,direction:_.RIGHT}),n<t.height&&(yield{x:i,y:n,direction:_.BOTTOM}),r>=0&&(yield{x:r,y:s,direction:_.LEFT})}function E(e,t,i,s){let[r,l]=e.y<t.y?[e.y,t.y]:[t.y,e.y],[o,n]=e.x<t.x?[e.x,t.x]:[t.x,e.x];return s(r,n,l,o,i)}function R(e,t,i,s,r){let l=new N;for(let o=s;o<=t;++o)l.add(T(o,e,r)),l.add(T(o,i,r));for(let o=e+1;o<i;++o)l.add(T(s,o,r)),l.add(T(t,o,r));return l}function O(e,t,i,s,r){let l=[];for(let o=e;o<=i;++o)for(let e=s;e<=t;++e)l.push(T(e,o,r));return l}function G(e,t,i,s,r){let l=Math.abs(t.x-e.x),o=Math.abs(t.y-e.y),n=new N;if(l||o)if(l)if(o)!function(e,t,i){let s=e**2,r=t**2,l=2*s,o=2*r,n=e,h=0,d=0,a=r*(1-2*e),c=s,u=o*e,_=0;for(;u>=_;)i(n,h++),_+=l,d+=c,c+=l,2*d+a>0&&(--n,u-=o,d+=a,a+=o);let g=n,p=h;for(n=0,h=t,d=0,a=r,c=s*(1-2*t),u=0,_=l*t;u<=_;)i(n++,h),u+=o,d+=a,a+=o,2*d+c>0&&(--h,_-=l,d+=c,c+=l);for(;h>=p;)i(n-1,h--);for(;n<=g;)i(n++,h)}(l,o,(t,l)=>r(t,l,e,i.width,i.height,n,s));else for(let t=0;t<=l;++t){let r=e.x+t,l=e.x-t;r<i.width&&n.add(T(r,e.y,s)),l>=0&&n.add(T(l,e.y,s))}else for(let t=0;t<=o;++t){let r=e.y+t,l=e.y-t;r<i.height&&n.add(T(e.x,r,s)),l>=0&&n.add(T(e.x,l,s))}else n.add(T(e.x,e.y,s));return n}function F(e,t,i,s,r,l,o){let n=i.x+e,h=i.x-e,d=i.y+t,a=i.y-t;n<s&&d<r&&l.add(T(n,d,o)),h>=0&&d<r&&l.add(T(h,d,o)),n<s&&a>=0&&l.add(T(n,a,o)),h>=0&&a>=0&&l.add(T(h,a,o))}function L(e,t,i,s,r,l,o){let n=Math.min(i.x+e,s-1),h=Math.max(0,i.x-e),d=Math.min(i.y+t,r-1),a=Math.max(0,i.y-t);for(let e=n;e>=i.x;--e)l.add(T(e,d,o)),l.add(T(e,a,o));for(let e=h;e<i.x;++e)l.add(T(e,d,o)),l.add(T(e,a,o))}function z(e,t){return e.find(e=>e.x===t.x&&e.y===t.y)}class B{constructor(){this._tiles=[]}get length(){return this._tiles.length}add(e){this._tiles.push(e)}*[Symbol.iterator](){yield*this._tiles}_find(e){return z(this._tiles,e)}}class N extends B{constructor(){super(),this._points=new Set}add(e){let t=v(e);this._points.has(t)||this._insert(e,t)}_insert(e,t){super.add(e),this._points.add(t)}}class M extends N{constructor(e,t){super(),this.terminal=e,this.lineSet=t}}class A extends M{solve(){for(let e of this._tiles){let t=0,i=this.lineSet;for(let s of k(e,this.terminal.dimensions))[t,i]=this._solveNeighborConstraints(s,t,i);e.cell.glyphId=i.getId(t)}}_solveNeighborConstraints(e,t,i){let s=this._find(e),r=s?.cell??this.terminal.getCell(e.x,e.y);return p(r.glyphId,_.complement(e.direction))&&(t|=e.direction,s||(i=m(this.lineSet,_.rotate(e.direction),r.glyphId))),[t,i]}}class D extends M{add(e){e=this._resolveTile(e);let t=[],i=0;for(let s of k(e,this.terminal.dimensions))i=this._processNeighbor(s,i,t),e.cell.glyphId=this.lineSet.getId(i);for(let e of t)super.add(e)}_resolveTile(e){let t=v(e);if(this._points.has(t)){let t=this._find(e);t.cell.update({fgColorId:e.cell.fgColorId,bgColorId:e.cell.bgColorId}),e=t}else e.cell=e.cell.clone({glyphId:this.lineSet.getId(_.RIGHT|_.LEFT)}),this._insert(e,t);return e}_processNeighbor(e,t,i){let s=this._find(e)??z(i,e),r=s?.cell??this.terminal.getCell(e.x,e.y),l=s?this.lineSet:m(this.lineSet,e.direction,r.glyphId);if(l){if(t|=e.direction,!s){let t=r.clone({glyphId:l.getId(_.RIGHT|_.LEFT)});s=T(e.x,e.y,t),i.push(s)}let o=_.complement(e.direction);for(let e of k(s,this.terminal.dimensions))o=this._processNeighborOfNeighbor(e,o,i);s.cell.glyphId=l.getId(o)}return t}_processNeighborOfNeighbor(e,t,i){let s=this._find(e)??z(i,e);return p((s?.cell??this.terminal.getCell(e.x,e.y)).glyphId,_.complement(e.direction))&&(t|=e.direction),t}}class H extends B{constructor(e){super(),this._fgColor=e.fgColorId,this._bgColor=e.bgColorId,this.cursorOn=new S(C.SIGILS.CURSOR,this._fgColor,this._bgColor),this.cursorOff=new S(C.SIGILS.TRANSPARENT,this._fgColor,this._bgColor)}advance(e,t){let i=new S(t,this._fgColor,this._bgColor);this.add(T(e.x,e.y,i))}newline(e){this.add(T(e.x,e.y,C.SIGILS.NEWLINE))}reverse(){return this._tiles.pop()}*[Symbol.iterator](){yield*this._tiles.filter(e=>e.cell!==C.SIGILS.NEWLINE)}}function P(e,t,i,s){return s??[T(t.x,t.y,e)]}function W(e,t,i,s){return(s=s??new N).add(T(i.x,i.y,e)),s}function V(e,t,i,s,r){let l=g(e.glyphId);return(s=s??(l?new D(r,l):new N)).add(T(i.x,i.y,e)),s}function $(e,t,i,s,r){if(s)return s;let l=new Set([v(t)]),o=[t],n=[T(t.x,t.y,e)],h=r.getCell(t.x,t.y);for(;o.length>0;)for(let t of k(o.shift(),r.dimensions)){let i=v(t);!l.has(i)&&(l.add(i),r.getCell(t.x,t.y).equals(h)&&(n.push(T(t.x,t.y,e)),o.push(t)))}return n}function j(e,t,i){return E(t,i,e,R)}function U(e,t,i){return E(t,i,e,O)}function q(e,t,i,s,r){let l=g(e.glyphId);return E(t,i,e,l?(...e)=>(function(e,t,i,s,r,l,o){let n=new A(e,t);for(let e=l;e<=s;++e)e===l?(n.add(T(e,i,o.clone({glyphId:t.getId(_.RIGHT|_.DOWN)}))),n.add(T(e,r,o.clone({glyphId:t.getId(_.TOP|_.RIGHT)})))):e===s?(n.add(T(e,i,o.clone({glyphId:t.getId(_.BOTTOM|_.LEFT)}))),n.add(T(e,r,o.clone({glyphId:t.getId(_.TOP|_.LEFT)})))):(n.add(T(e,i,o.clone({glyphId:t.getId(_.RIGHT|_.LEFT)}))),n.add(T(e,r,o.clone({glyphId:t.getId(_.RIGHT|_.LEFT)}))));for(let e=i+1;e<r;++e)n.add(T(l,e,o.clone({glyphId:t.getId(_.TOP|_.BOTTOM)}))),n.add(T(s,e,o.clone({glyphId:t.getId(_.TOP|_.BOTTOM)})));return n.solve(),n})(r,l,...e):R)}function K(e,t,i,s,r){return G(t,i,r.dimensions,e,F)}function Y(e,t,i,s,r){return G(t,i,r.dimensions,e,L)}function J(e,t,i){return function(e,t,i,s,r){let l=Math.abs(i-e),o=-Math.abs(s-t),n=e<i?1:-1,h=t<s?1:-1,d=new N,a=l+o;for(;d.add(T(e,t,r)),e!==i||t!==s;){let i=2*a;i>=o&&(a+=o,e+=n),i<=l&&(a+=l,t+=h)}return d}(t.x,t.y,i.x,i.y,e)}function Q(e,t,i,s){return s??new H(e)}function X(e,t,i,s,r){if(s)return s;let l=r.getCell(t.x,t.y),o=[];if(l.equals(e))return o;let{width:n,height:h}=r.dimensions;for(let t=0;t<h;++t)for(let i=0;i<n;++i)r.getCell(i,t).equals(l)&&o.push(T(i,t,e));return o}function Z(e){return{x:parseInt(e.dataset.x,10),y:parseInt(e.dataset.y,10)}}class ee{constructor(e,t,i,s){this.onState=e,this.offState=t,this.draw=i,this.restore=s,this._on=!1}get position(){return this._position}set(e){clearInterval(this._timer),this._start(e)}reset(e){this._on=!1,clearInterval(this._timer),this.restore(this.position),e&&this._start(e)}clear(){clearInterval(this._timer)}_start(e){this._on=!0,this._position={...e},this._toggle(),this._timer=setInterval(this._toggle.bind(this),600)}_toggle(){this.draw(this.position.x,this.position.y,this._on?this.onState:this.offState),this._on=!this._on}}class et{constructor(e,t,i){this.updateFigure=e,this.sketchpad=t,this.terminal=i,this._started=!1}handleEvent(e){let t=e.type.replace(e.type[0],e.type[0].toUpperCase()),i=`on${t}`;return this[i]?this[i](e):null}}class ei extends et{constructor(...e){super(...e),this._prevDrawTiles=[]}_drawFigure(){let e=new Set,t=[];for(let{x:i,y:s,cell:r}of this._activeFigure){this.sketchpad.updateAt(i,s,r);let l={x:i,y:s};e.add(v(l)),t.push(l)}for(let t of this._prevDrawTiles)if(!e.has(v(t))){let{x:e,y:i}=t,s=this.terminal.getCell(e,i);this.sketchpad.updateAt(e,i,s)}this._prevDrawTiles=t}}class es extends ei{onMousedown(e){return this._started=!0,this._start=this._end=Z(e.target),this._activeFigure=this.updateFigure(this._start,this._end,this._activeFigure,this.terminal),this._drawFigure(),null}onMouseover(e){return this._started&&(this._end=Z(e.target),this._activeFigure=this.updateFigure(this._start,this._end,this._activeFigure,this.terminal),this._drawFigure()),null}onMouseup(e){return this._activeFigure}}class er extends ei{onMousedown(e){return this._started?this.cleanup():(this._started=!0,this._dimensions=this.terminal.dimensions,this._activeFigure=this.updateFigure(),this._start=this._end=Z(e.target),this._cursor=new ee(this._activeFigure.cursorOn,this._activeFigure.cursorOff,this._drawCursor.bind(this),this._restoreCell.bind(this)),this._cursor.set(this._start),console.log("START CURSOR POS: %o",this._start),null)}onKeydown(e){if(!this._started||e.altKey||e.ctrlKey||e.metaKey)return null;switch(e.preventDefault(),e.key){case"Backspace":this._reverseCharacter();break;case"Enter":this._newline();break;case"Escape":return this.cleanup();case" ":this._advanceCharacter(this._cursor.offState.glyphId);break;default:this._advanceCharacter(C.id(e.key))}return null}cleanup(){return this._started?(this._cursor.reset(),this._activeFigure):null}get _isValidPosition(){return this._end.y>=0&&this._end.y<this._dimensions.height}_advanceCharacter(e){this._isValidPosition&&!(e<0)&&(this._activeFigure.advance(this._end,e),this._advanceCursor(),this._drawFigure())}_advanceCursor(){let{x:e,y:t}=this._end;++e>=this._dimensions.width&&(e=0,++t),this._end={x:e,y:t},t<this._dimensions.height?this._cursor.set(this._end):this._cursor.clear(),console.log("NEW CURSOR POS: %o",this._end)}_reverseCharacter(){let e=this._activeFigure.reverse();e&&(this._end={x:e.x,y:e.y},this._cursor.reset(this._end)),console.log("REVERSE CURSOR POS: %o",this._end)}_newline(){this._activeFigure.newline(this._end);let e=this._end.y+1;e<this._dimensions.height&&(this._end={x:this._start.x,y:e},this._cursor.reset(this._end)),console.log("NL CURSOR POS: %o",this._end)}_drawCursor(e,t,i){this.sketchpad.updateAt(e,t,i)}_restoreCell(e){let t=this.terminal.getCell(e.x,e.y);this.sketchpad.updateAt(e.x,e.y,t)}}class el extends et{onMouseup(e){this._started=!0,e.stopPropagation();let t=Z(e.target);return Number.isNaN(t.x)||Number.isNaN(t.y)||this.sketchpad.commitCellSampling(this.terminal.getCell(t.x,t.y)),this.updateFigure()}}class eo{constructor(e,t,i){this.models=e,this.gestureCls=t,this.figure=i}forward(e,t){return this._gesture||(this._gesture=this._createGesture(e)),this._gesture.handleEvent(t)}committed(e){this._gesture=null}cleanup(e){return this.committed(e),null}_createGesture(e){return new this.gestureCls((e,t,i,s)=>this.figure(this.models.lettertype.cell,e,t,i,s),e,this.models.terminal)}}class en extends eo{constructor(e){super(e,er,Q)}forward(e,t){let i=super.forward(e,t);return i&&(this._pendingGesture=this._createGesture(e),this._pendingGesture.handleEvent(t)),i}committed(e){this._gesture=this._pendingGesture,this._pendingGesture=null}cleanup(e){let t=this._gesture.cleanup();return this._gesture=this._pendingGesture=null,t}}class eh extends eo{constructor(e){super(e,el,()=>[])}}let ed={point:{name:"Single Cell",make:e=>new eo(e,es,P)},brush:{name:"Free Draw",make:e=>new eo(e,es,W)},boxBrush:{name:"Box Draw",make:e=>new eo(e,es,V)},fill:{name:"Fill",make:e=>new eo(e,es,$)},rect:{name:"Rectangle",make:e=>new eo(e,es,j)},fillRect:{name:"Filled Rectangle",make:e=>new eo(e,es,U)},boxRect:{name:"Box Rectangle",make:e=>new eo(e,es,q)},ellipse:{name:"Ellipse",make:e=>new eo(e,es,K)},fillEllipse:{name:"Filled Ellipse",make:e=>new eo(e,es,Y)},line:{name:"Line",make:e=>new eo(e,es,J)},text:{name:"Text",make:e=>new en(e)},swap:{name:"Replace",make:e=>new eo(e,es,X)},eyedrop:{name:"Eyedrop",make:e=>new eh(e)}},ea=Object.fromEntries(Object.entries(ed).map(([e,t])=>[e,t.name])),ec=Object.fromEntries(Object.keys(ed).map(e=>[e,e]));function eu(e){let t=ed[e.currentTool];if(!t)throw Error(`Unknown tool: ${e.currentTool}`);return t.make(e)}function e_(e,t){return{event:e,...t}}let eg={commitDraw:(e,t,s=!1)=>()=>(e.terminal.update(t),e_(i.onDrawCommitted,{figure:t,cleanup:s})),checkResizeTerminal:(e,t)=>()=>{let s=e.terminal.dimensions;return e_(t.columns<s.width||t.rows<s.height?i.onTerminalResizeVerify:i.onTerminalResizeReady,{dims:t})},commitResizeTerminal:(e,t)=>()=>(console.log("resized terminal: %o",t),e.terminal.resize(t.columns,t.rows),e.lettertype.fontSize=t.fontSize,e_(i.onTerminalResized,{terminal:e.terminal,fontSize:t.fontSize})),setBackgroundColor:(e,t)=>()=>(e.lettertype.cell.bgColorId=t,e_(i.onBackgroundColorChanged,{colorId:t})),setForegroundColor:(e,t)=>()=>(e.lettertype.cell.fgColorId=t,e_(i.onForegroundColorChanged,{colorId:t})),setGlyph:(e,t)=>()=>(e.lettertype.cell.glyphId=t,e_(i.onGlyphChanged,{glyphId:t})),setTool:(e,t)=>()=>(e.currentTool=t,e_(i.onToolChanged,{tool:eu(e),name:t}))},ep=Object.fromEntries(Object.keys(eg).map(e=>[e,e]));class em{constructor(e,t){this.notifier=e,this._bindCommands(t)}command(e,...t){let i=this._commands[e];if(!i)throw Error(`Unknown command: ${e}`);let s=i(...t)();this.notifier.signal(s)}_bindCommands(e){this._commands=Object.fromEntries(Object.entries(eg).map(([t,i])=>[t,(...t)=>i(e,...t)]))}}class ef{constructor(e,t){this._stride=this._height=0,this.resize(e,t)}get dimensions(){return{width:this._stride,height:this._height}}resize(e,t){if(e<1||e>65536||t<1||t>65536)throw Error(`Terminal dimensions must be in range [1, 65536]; got arguments {columns: ${e}, rows: ${t}}`);if(e===this._stride&&t===this._height)return;let i=this._newCellGrid(e,t);this._stride=e,this._height=t,this._cells=i}getCell(e,t){let i=e+t*this._stride;return this._cells[i]}updateCell(e,t,i){this.getCell(e,t).update(i)}update(e){for(let{x:t,y:i,cell:s}of e)this.updateCell(t,i,s)}_newCellGrid(e,t){let i=[],s=Math.trunc((this._stride-e)/2),r=Math.trunc((this._height-t)/2);for(let l=0;l<t;++l)for(let t=0;t<e;++t){let e=t+s,o=l+r,n=this._getResizeAdjustedCell(e,o);i.push(n??new S)}return i}_getResizeAdjustedCell(e,t){return e>=0&&e<this._stride&&t>=0&&t<this._height?this.getCell(e,t):null}}class ey{constructor(e,t){this.doc=e,this.dispatch=t}}function eC(e){return!0}function eI(e){return!!g(e)}class eb extends ey{constructor(e,t,i,s,r,...l){super(...l),this._selection=this.doc.getElementById(e),this.cmd=t,this.refreshEvent=i,this.onSelected=s,this.colorInitializer=r}draw(e){this._setColor(this.colorInitializer(e.colors)),this._selection.addEventListener("click",e=>this.onSelected(this))}subscribe(e){e.subscribe(this.refreshEvent,this._refreshColor.bind(this))}select(){this._selection.classList.add("selected")}deselect(){this._selection.classList.remove("selected")}pick(e){this.dispatch.command(this.cmd,e)}_refreshColor(e){this._setColor(e.colorId)}_setColor(e){this._selection.style.backgroundColor=x.cssColor(e),this._selection.title=x.name(e)}}let ew=[class extends ey{constructor(...e){super(...e),this._palette=this.doc.getElementById("palette");let t=this._setSelection.bind(this);this._colorSelections=[new eb("fg-color",ep.setForegroundColor,i.onForegroundColorChanged,t,e=>e.fg,...e),new eb("bg-color",ep.setBackgroundColor,i.onBackgroundColorChanged,t,e=>e.bg,...e)]}draw(e){for(let[e,t]of x.enumerate()){let i=this.doc.createElement("div");i.className="palette-cell",i.dataset.id=e,i.title=x.name(e),i.style.backgroundColor=t,i.addEventListener("click",this._pickColor.bind(this)),this._palette.appendChild(i)}for(let t of this._colorSelections)t.draw(e);this._setSelection(this._colorSelections[0])}subscribe(e){for(let t of this._colorSelections)t.subscribe(e)}_setSelection(e){for(let e of this._colorSelections)e.deselect();e.select(),this._currentSelection=e}_pickColor(e){let t=parseInt(e.target.dataset.id,10);this._currentSelection.pick(t)}},class extends ey{constructor(...e){super(...e),this._block=this.doc.getElementById("letter-block"),this._selectable=eC}draw(e){for(let[t,i]of C.enumerate()){let s=this.doc.createElement("span");s.dataset.id=t,s.textContent=i;let r=this.doc.createElement("div");r.appendChild(s),t===e.glyphId&&(r.className="selected",this._selectedBlock=r),r.addEventListener("click",this._pickGlyph.bind(this)),this._block.appendChild(r)}}subscribe(e){e.subscribe(i.onGlyphChanged,this._refreshGlyph.bind(this)),e.subscribe(i.onToolChanged,this._updateSelectionMode.bind(this))}_refreshGlyph(e){let t=e.glyphId;for(let e of(this._selectable===eI?this._lastBoxGlyph=t:(this._lastGlyph=t,g(t)&&(this._lastBoxGlyph=t)),this._block.children))if(e.firstElementChild.dataset.id===t.toString()){this._selectedBlock.classList.remove("selected"),e.className="selected",this._selectedBlock=e;break}}_updateSelectionMode(e){let t,i;e.name.startsWith("box")?(i=eI,t=this._lastBoxGlyph??f):(i=eC,t=this._lastGlyph??C.SIGILS.DEFAULT),i!==this._selectable&&(this._selectable=i,this._applySelectionPredicate(),g(this._lastGlyph)||this.dispatch.command(ep.setGlyph,t))}_pickGlyph(e){let t=e.target;if(t.classList.contains("disabled"))e.preventDefault();else{let e=parseInt(t.firstElementChild.dataset.id,10);this.dispatch.command(ep.setGlyph,e)}}_applySelectionPredicate(){for(let e of this._block.children)this._selectable(e.firstElementChild.dataset.id)?e.classList.remove("disabled"):e.classList.add("disabled")}},class extends ey{constructor(...e){super(...e),this._form=this.doc.getElementById("sketchpad-controls"),this._button=this._form.querySelector("button"),this._inputControls=[this.doc.getElementById("font-size"),this.doc.getElementById("column-count"),this.doc.getElementById("row-count")]}get fontSize(){return parseInt(this._inputControls[0].value,10)}get columns(){return parseInt(this._inputControls[1].value,10)}get rows(){return parseInt(this._inputControls[2].value,10)}draw(e){let t=e.terminal.dimensions;for(let i of([e.fontSize,t.width,t.height].forEach((e,t)=>{let i=this._inputControls[t];i.dataset.currentValue=i.value=e}),this._inputControls))i.addEventListener("input",this._updateButton.bind(this));this._form.addEventListener("submit",this._updateSketchpadDims.bind(this))}subscribe(e){e.subscribe(i.onTerminalResizeVerify,this._verifyResize.bind(this)),e.subscribe(i.onTerminalResizeReady,this._commitResize.bind(this))}_updateSketchpadDims(e){e.preventDefault();let t={fontSize:this.fontSize,columns:this.columns,rows:this.rows};this.dispatch.command(ep.checkResizeTerminal,t)}_verifyResize(e){if(this.doc.defaultView.confirm("Reducing the drawing size may discard portions of your current sketch. Continue?"))this._commitResize(e);else{for(let e of this._inputControls)e.value=e.dataset.currentValue;this._updateButton()}}_commitResize(e){for(let e of this._inputControls)e.dataset.currentValue=e.value;this._updateButton(),this.dispatch.command(ep.commitResizeTerminal,e.dims)}_updateButton(){this._button.disabled=this._inputControls.every(e=>e.value===e.dataset.currentValue)}},class extends ey{constructor(...e){super(...e),this._ruler=this.doc.getElementById("glyph-ruler"),this._sketchpad=this.doc.getElementById("sketchpad"),this._grid=[],this._stride=0}draw(e){this._tool=e.tool,this._drawSketchpad(e.terminal,e.fontSize),this.doc.addEventListener("mouseup",this._handleGesture.bind(this)),this.doc.addEventListener("keydown",this._handleGesture.bind(this))}subscribe(e){e.subscribe(i.onDrawCommitted,this._committed.bind(this)),e.subscribe(i.onToolChanged,this._updateTool.bind(this)),e.subscribe(i.onTerminalResized,this._resizeSketchpad.bind(this))}updateAt(e,t,i){let s=e+t*this._stride,r=this._grid[s];if(!r)return void console.warn("Invalid grid index %d: (%d, %d)",s,e,t);let l=r.firstChild;l.textContent=C.glyph(i.glyphId),l.style.color=x.cssColor(i.fgColorId),l.style.backgroundColor=x.cssColor(i.bgColorId)}commitCellSampling(e){this.dispatch.command(ep.setForegroundColor,e.fgColorId),this.dispatch.command(ep.setBackgroundColor,e.bgColorId),this.dispatch.command(ep.setGlyph,e.glyphId)}_drawSketchpad(e,t){let i=this._measureGlyph(t),s=e.dimensions;this._stride=s.width,console.log("Tilesize: %o",i),console.log("TermSize: %o",s);let r=this._sketchpad.style;r.fontSize=`${t}px`,r.width=`${s.width*i.width}px`,r.height=`${s.height*i.height}px`,r.gridTemplateColumns=`repeat(${s.width}, 1fr)`;let l=`${i.width}px`,o=`${i.height}px`,n=["mousedown","mouseover","mouseup"];for(this._grid.length=0;this._sketchpad.firstChild;)this._sketchpad.removeChild(this._sketchpad.firstChild);for(let t=0;t<s.height;++t)for(let i=0;i<s.width;++i){let s=this.doc.createElement("div");for(let e of(s.appendChild(this.doc.createElement("span")),s.style.width=l,s.style.height=o,s.dataset.x=i,s.dataset.y=t,n))s.addEventListener(e,this._handleGesture.bind(this));this._grid.push(s),this._sketchpad.appendChild(s),this.updateAt(i,t,e.getCell(i,t))}}_measureGlyph(e){this._ruler.style.fontSize=`${e}px`;let t={minWidth:100,maxWidth:0,minHeight:100,maxHeight:0};t=[...C.glyphs()].reduce((e,t)=>{this._ruler.textContent=t;let{width:i,height:s}=this._ruler.getBoundingClientRect();return{minWidth:Math.min(e.minWidth,i||e.minWidth),maxWidth:Math.max(e.maxWidth,i),minHeight:Math.min(e.minHeight,s||e.minHeight),maxHeight:Math.max(e.maxHeight,s)}},t),this._ruler.textContent=C.glyph(C.SIGILS.DEFAULT);let{width:i,height:s}=this._ruler.getBoundingClientRect();return console.log("Font dims: %o",t),console.log("Bounding rect: %o",{width:i,height:s}),{width:Math.floor(i),height:Math.floor(s)}}_handleGesture(e){let t=this._tool.forward(this,e);t&&(this.dispatch.command(ep.commitDraw,t),console.log("generated figure: %o",t))}_committed(e){e.cleanup||(console.log("commit figure"),this._tool.committed(e))}_updateTool(e){let t=this._tool.cleanup();t&&(this.dispatch.command(ep.commitDraw,t,!0),console.log("got cleanup figure: %o",t)),this._tool=e.tool}_resizeSketchpad(e){this._drawSketchpad(e.terminal,e.fontSize)}},class extends ey{constructor(...e){super(...e),this._toolSelector=this.doc.getElementById("tool-selections"),this._toolSelections=[]}draw(e){for(let t of Object.values(ec)){let i=this.doc.createElement("input");i.type="radio",i.id=`tool-selection-${t}`,i.name="tool-selection",i.value=t,i.checked=t===e.toolName,i.addEventListener("input",this._pickTool.bind(this));let s=this.doc.createElement("label");s.htmlFor=i.id,s.title=ea[t],s.className=`tool-${t}`,this._toolSelector.appendChild(i),this._toolSelector.appendChild(s),this._toolSelections.push(i)}}subscribe(e){e.subscribe(i.onToolChanged,this._refreshTool.bind(this))}_pickTool(e){this.dispatch.command(ep.setTool,e.target.value)}_refreshTool(e){for(let t of this._toolSelections)t.checked=t.value===e.name}}];class ex{constructor(e){this.win=e,this._doc=e.document,this._notifier=new s}initialize(){this._createModels(),this._wireCommands(),this._createViews(),this._registerViews(),this._drawViews(),console.log("started letter-sketch")}_createModels(){this._models={currentTool:ec.brush,lettertype:{cell:new S(C.SIGILS.DEFAULT),fontSize:20},terminal:new ef(80,25)}}_wireCommands(){this._dispatch=new em(this._notifier,this._models)}_createViews(){this._views=ew.map(e=>new e(this._doc,this._dispatch))}_registerViews(){this._notifier.register(...this._views)}_drawViews(){let e=this._initialState();for(let t of this._views)t.draw(e)}_initialState(){return{colors:{bg:this._models.lettertype.cell.bgColorId,fg:this._models.lettertype.cell.fgColorId},fontSize:this._models.lettertype.fontSize,glyphId:this._models.lettertype.cell.glyphId,terminal:this._models.terminal,tool:eu(this._models),toolName:this._models.currentTool}}}t.lettersketch={start(e){new ex(e).initialize()}};
//# sourceMappingURL=letter-sketch.1d71202a.js.map
