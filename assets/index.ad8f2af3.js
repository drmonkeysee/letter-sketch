var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};const e=Object.fromEntries(["onBackgroundColorChanged","onDrawCommitted","onForegroundColorChanged","onGlyphChanged","onTerminalResized","onTerminalResizeReady","onTerminalResizeVerify","onToolChanged"].map((t=>[t,t])));class s{register(...t){for(const e of t)e.subscribe(this)}subscribe(t,e){let s=this._notifications[t];s||(this._notifications[t]=s=[]),s.push(e)}signal(t){const e=this._notifications[t.event];if(e)for(const s of e)s(t)}constructor(){this._notifications={}}}const i={179:10,180:14,191:12,192:3,193:7,194:13,195:11,196:5,197:15,217:6,218:9},o={185:14,186:10,187:12,188:6,200:3,201:9,202:7,203:13,204:11,205:5,206:15},n={179:10,181:14,184:12,190:6,198:11,205:5,207:7,209:13,212:3,213:9,216:15},r={182:14,183:12,186:10,189:6,196:5,199:11,208:7,210:13,211:3,214:9,215:15};class l{getId(t){return this.bestFit[t]}hasAttractor(t,e){return Boolean(this.lines[t]&e)}constructor(t,e){this.lines=t,this.bestFit=e}}const h=new l(i,[196,196,179,192,196,196,217,193,179,218,179,195,191,194,180,197]),d=new l(o,[205,205,186,200,205,205,188,202,186,201,186,204,187,203,185,206]),c=new l(n,[205,205,179,212,205,205,190,207,179,213,179,198,184,209,181,216]),a=new l(r,[196,196,186,211,196,196,189,208,186,214,186,199,183,210,182,215]),u={NONE:0,RIGHT:1,TOP:2,LEFT:4,BOTTOM:8,complement:t=>t>2?t>>2:t<<2,rotate(t){switch(t){case u.RIGHT:case u.TOP:case u.LEFT:return t<<1;case u.BOTTOM:return u.RIGHT;default:return t}}};function _(t){return i[t]?h:o[t]?d:n[t]?c:r[t]?a:null}function g(t){return Boolean(_(t))}function p(t,e){var s;return Boolean(null===(s=_(t))||void 0===s?void 0:s.hasAttractor(t,e))}function m(t,e,s){const i=_(s);let o=null,n=null;switch(e){case u.TOP:case u.BOTTOM:o=c,n=a;break;case u.RIGHT:case u.LEFT:o=a,n=c}if(!o)return null;switch(t){case h:case o:switch(i){case h:case n:return h;case d:case o:return o}break;case d:case n:switch(i){case h:case n:return n;case d:case o:return d}}return null}const f=Number.parseInt(Object.keys(i)[0],10),y=["␀","☺","☻","♥","♦","♣","♠","•","◘","○","◙","♂","♀","♪","♫","☼","►","◄","↕","‼","¶","§","▬","↨","↑","↓","→","←","∟","↔","▲","▼"," ","!",'"',"#","$","%","&","'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\","]","^","_","`","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","{","|","}","~","⌂","Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","¢","£","¥","₧","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","⌐","¬","½","¼","¡","«","»","░","▒","▓","│","┤","╡","╢","╖","╕","╣","║","╗","╝","╜","╛","┐","└","┴","┬","├","─","┼","╞","╟","╚","╔","╩","╦","╠","═","╬","╧","╨","╤","╥","╙","╘","╒","╓","╫","╪","┘","┌","█","▄","▌","▐","▀","α","ß","Γ","π","Σ","σ","µ","τ","Φ","Θ","Ω","δ","∞","φ","ε","∩","≡","±","≥","≤","⌠","⌡","÷","≈","°","∙","·","√","ⁿ","²","■"," "];var C={*glyphs(){yield*y},*enumerate(){yield*y.entries()},glyph:t=>y[t],id:t=>y.indexOf(t),SIGILS:{DEFAULT:65,CLEAR:32,CURSOR:124,TRANSPARENT:255,NEWLINE:"\n"}};function I(t){let e,s,i;if(3===t.length)[e,s,i]=t,e+=e,s+=s,i+=i;else{if(6!==t.length)return"";e=t.slice(0,2),s=t.slice(2,4),i=t.slice(4,6)}return`rgb(${parseInt(e,16)}, ${parseInt(s,16)}, ${parseInt(i,16)})`}const[b,w]=function(){const t={White:I("ffffff"),Silver:I("c0c0c0"),Gray:I("808080"),Black:I("000000"),Red:I("ff0000"),Maroon:I("800000"),Yellow:I("ffff00"),Olive:I("808000"),Lime:I("00ff00"),Green:I("008000"),Aqua:I("00ffff"),Teal:I("008080"),Blue:I("0000ff"),Navy:I("000080"),Fuchsia:I("ff00ff"),Purple:I("800080")};return[Object.keys(t),Object.values(t)]}();var x={*cssColors(){yield*w},*enumerate(){yield*w.entries()},cssColor:t=>w[t],name:t=>b[t],id:t=>(t.startsWith("#")&&(t=I(t.substring(1))),w.indexOf(t)),COLORS:{BLACK:b.indexOf("Black"),WHITE:b.indexOf("White")}};class v{get glyphId(){return this._glyphId}set glyphId(t){this._glyphId=null!=t?t:C.SIGILS.CLEAR}get fgColorId(){return this._fgColorId}set fgColorId(t){this._fgColorId=null!=t?t:x.COLORS.BLACK}get bgColorId(){return this._bgColorId}set bgColorId(t){this._bgColorId=null!=t?t:x.COLORS.WHITE}isEmpty(){return this.glyphId===C.SIGILS.CLEAR}equals(t){return this.glyphId===t.glyphId&&this.fgColorId===t.fgColorId&&this.bgColorId===t.bgColorId}update({glyphId:t=this.glyphId,fgColorId:e=this.fgColorId,bgColorId:s=this.bgColorId}){this._setFields(t,e,s)}clone({glyphId:t=this.glyphId,fgColorId:e=this.fgColorId,bgColorId:s=this.bgColorId}={}){return new v(t,e,s)}_setFields(t,e,s){this.glyphId=t,this.fgColorId=e,this.bgColorId=s}constructor(t,e,s){this._setFields(t,e,s)}}function S(t,e,s){return{x:t,y:e,cell:s}}function T(t){return t.x<<16^t.y}function*k(t,e){const{x:s,y:i}=t,o=s-1,n=i-1,r=s+1,l=i+1;n>=0&&(yield{x:s,y:n,direction:u.TOP}),r<e.width&&(yield{x:r,y:i,direction:u.RIGHT}),l<e.height&&(yield{x:s,y:l,direction:u.BOTTOM}),o>=0&&(yield{x:o,y:i,direction:u.LEFT})}function E(t,e,s,i){const[o,n]=t.y<e.y?[t.y,e.y]:[e.y,t.y],[r,l]=t.x<e.x?[t.x,e.x]:[e.x,t.x];return i(o,l,n,r,s)}function R(t,e,s,i,o){const n=new N;for(let r=i;r<=e;++r)n.add(S(r,t,o)),n.add(S(r,s,o));for(let r=t+1;r<s;++r)n.add(S(i,r,o)),n.add(S(e,r,o));return n}function O(t,e,s,i,o){const n=[];for(let r=t;r<=s;++r)for(let t=i;t<=e;++t)n.push(S(t,r,o));return n}function G(t,e,s,i,o){const n=Math.abs(e.x-t.x),r=Math.abs(e.y-t.y),l=new N;if(n||r)if(n)if(r)!function(t,e,s){const i=t**2,o=e**2,n=2*i,r=2*o;let l=t,h=0,d=0,c=o*(1-2*t),a=i,u=r*t,_=0;for(;u>=_;)s(l,h++),_+=n,d+=a,a+=n,2*d+c>0&&(--l,u-=r,d+=c,c+=r);const g=l,p=h;l=0,h=e,d=0,c=o,a=i*(1-2*e),u=0,_=n*e;for(;u<=_;)s(l++,h),u+=r,d+=c,c+=r,2*d+a>0&&(--h,_-=n,d+=a,a+=n);for(;h>=p;)s(l-1,h--);for(;l<=g;)s(l++,h)}(n,r,((e,n)=>o(e,n,t,s.width,s.height,l,i)));else for(let e=0;e<=n;++e){const o=t.x+e,n=t.x-e;o<s.width&&l.add(S(o,t.y,i)),n>=0&&l.add(S(n,t.y,i))}else for(let e=0;e<=r;++e){const o=t.y+e,n=t.y-e;o<s.height&&l.add(S(t.x,o,i)),n>=0&&l.add(S(t.x,n,i))}else l.add(S(t.x,t.y,i));return l}function F(t,e,s,i,o,n,r){const l=s.x+t,h=s.x-t,d=s.y+e,c=s.y-e;l<i&&d<o&&n.add(S(l,d,r)),h>=0&&d<o&&n.add(S(h,d,r)),l<i&&c>=0&&n.add(S(l,c,r)),h>=0&&c>=0&&n.add(S(h,c,r))}function L(t,e,s,i,o,n,r){const l=Math.min(s.x+t,i-1),h=Math.max(0,s.x-t),d=Math.min(s.y+e,o-1),c=Math.max(0,s.y-e);for(let t=l;t>=s.x;--t)n.add(S(t,d,r)),n.add(S(t,c,r));for(let t=h;t<s.x;++t)n.add(S(t,d,r)),n.add(S(t,c,r))}function z(t,e){return t.find((t=>t.x===e.x&&t.y===e.y))}class B{get length(){return this._tiles.length}add(t){this._tiles.push(t)}*[Symbol.iterator](){yield*this._tiles}_find(t){return z(this._tiles,t)}constructor(){this._tiles=[]}}class N extends B{add(t){const e=T(t);this._points.has(e)||this._insert(t,e)}_insert(t,e){super.add(t),this._points.add(e)}constructor(){super(),this._points=new Set}}class M extends N{constructor(t,e){super(),this.terminal=t,this.lineSet=e}}class A extends M{solve(){for(const t of this._tiles){let e=0,s=this.lineSet;for(const i of k(t,this.terminal.dimensions))[e,s]=this._solveNeighborConstraints(i,e,s);t.cell.glyphId=s.getId(e)}}_solveNeighborConstraints(t,e,s){var i;const o=this._find(t),n=null!==(i=null==o?void 0:o.cell)&&void 0!==i?i:this.terminal.getCell(t.x,t.y);return p(n.glyphId,u.complement(t.direction))&&(e|=t.direction,o||(s=m(this.lineSet,u.rotate(t.direction),n.glyphId))),[e,s]}}class D extends M{add(t){t=this._resolveTile(t);const e=[];let s=0;for(const i of k(t,this.terminal.dimensions))s=this._processNeighbor(i,s,e),t.cell.glyphId=this.lineSet.getId(s);for(const t of e)super.add(t)}_resolveTile(t){const e=T(t);if(this._points.has(e)){const e=this._find(t);e.cell.update({fgColorId:t.cell.fgColorId,bgColorId:t.cell.bgColorId}),t=e}else t.cell=t.cell.clone({glyphId:this.lineSet.getId(u.RIGHT|u.LEFT)}),this._insert(t,e);return t}_processNeighbor(t,e,s){var i;let o=null!==(i=this._find(t))&&void 0!==i?i:z(s,t);var n;const r=null!==(n=null==o?void 0:o.cell)&&void 0!==n?n:this.terminal.getCell(t.x,t.y),l=o?this.lineSet:m(this.lineSet,t.direction,r.glyphId);if(l){if(e|=t.direction,!o){const e=r.clone({glyphId:l.getId(u.RIGHT|u.LEFT)});o=S(t.x,t.y,e),s.push(o)}let i=u.complement(t.direction);for(const t of k(o,this.terminal.dimensions))i=this._processNeighborOfNeighbor(t,i,s);o.cell.glyphId=l.getId(i)}return e}_processNeighborOfNeighbor(t,e,s){var i,o;const n=null!==(i=this._find(t))&&void 0!==i?i:z(s,t);return p((null!==(o=null==n?void 0:n.cell)&&void 0!==o?o:this.terminal.getCell(t.x,t.y)).glyphId,u.complement(t.direction))&&(e|=t.direction),e}}class H extends B{advance(t,e){const s=new v(e,this._fgColor,this._bgColor);this.add(S(t.x,t.y,s))}newline(t){this.add(S(t.x,t.y,C.SIGILS.NEWLINE))}reverse(){return this._tiles.pop()}*[Symbol.iterator](){yield*this._tiles.filter((t=>t.cell!==C.SIGILS.NEWLINE))}constructor(t){super(),this._fgColor=t.fgColorId,this._bgColor=t.bgColorId,this.cursorOn=new v(C.SIGILS.CURSOR,this._fgColor,this._bgColor),this.cursorOff=new v(C.SIGILS.TRANSPARENT,this._fgColor,this._bgColor)}}function P(t,e,s,i){return null!=i?i:[S(e.x,e.y,t)]}function W(t,e,s,i){return(i=null!=i?i:new N).add(S(s.x,s.y,t)),i}function V(t,e,s,i,o){const n=_(t.glyphId);return(i=null!=i?i:n?new D(o,n):new N).add(S(s.x,s.y,t)),i}function j(t,e,s,i,o){if(i)return i;const n=new Set([T(e)]),r=[e],l=[S(e.x,e.y,t)],h=o.getCell(e.x,e.y);for(;r.length>0;){const e=r.shift();for(const s of k(e,o.dimensions)){const e=T(s);if(n.has(e))continue;n.add(e);o.getCell(s.x,s.y).equals(h)&&(l.push(S(s.x,s.y,t)),r.push(s))}}return l}function $(t,e,s){return E(e,s,t,R)}function U(t,e,s){return E(e,s,t,O)}function q(t,e,s,i,o){const n=_(t.glyphId);return E(e,s,t,n?(...t)=>function(t,e,s,i,o,n,r){const l=new A(t,e);for(let t=n;t<=i;++t)t===n?(l.add(S(t,s,r.clone({glyphId:e.getId(u.RIGHT|u.DOWN)}))),l.add(S(t,o,r.clone({glyphId:e.getId(u.TOP|u.RIGHT)})))):t===i?(l.add(S(t,s,r.clone({glyphId:e.getId(u.BOTTOM|u.LEFT)}))),l.add(S(t,o,r.clone({glyphId:e.getId(u.TOP|u.LEFT)})))):(l.add(S(t,s,r.clone({glyphId:e.getId(u.RIGHT|u.LEFT)}))),l.add(S(t,o,r.clone({glyphId:e.getId(u.RIGHT|u.LEFT)}))));for(let t=s+1;t<o;++t)l.add(S(n,t,r.clone({glyphId:e.getId(u.TOP|u.BOTTOM)}))),l.add(S(i,t,r.clone({glyphId:e.getId(u.TOP|u.BOTTOM)})));return l.solve(),l}(o,n,...t):R)}function K(t,e,s,i,o){return G(e,s,o.dimensions,t,F)}function Y(t,e,s,i,o){return G(e,s,o.dimensions,t,L)}function J(t,e,s){return function(t,e,s,i,o){const n=Math.abs(s-t),r=-Math.abs(i-e),l=t<s?1:-1,h=e<i?1:-1,d=new N;let c=n+r;for(;d.add(S(t,e,o)),t!==s||e!==i;){const s=2*c;s>=r&&(c+=r,t+=l),s<=n&&(c+=n,e+=h)}return d}(e.x,e.y,s.x,s.y,t)}function Q(t,e,s,i){return null!=i?i:new H(t)}function X(t,e,s,i,o){if(i)return i;const n=o.getCell(e.x,e.y),r=[];if(n.equals(t))return r;const{width:l,height:h}=o.dimensions;for(let e=0;e<h;++e)for(let s=0;s<l;++s){o.getCell(s,e).equals(n)&&r.push(S(s,e,t))}return r}function Z(t){return{x:parseInt(t.dataset.x,10),y:parseInt(t.dataset.y,10)}}class tt{get position(){return this._position}set(t){clearInterval(this._timer),this._start(t)}reset(t){this._on=!1,clearInterval(this._timer),this.restore(this.position),t&&this._start(t)}clear(){clearInterval(this._timer)}_start(t){this._on=!0,this._position={...t},this._toggle(),this._timer=setInterval(this._toggle.bind(this),600)}_toggle(){this.draw(this.position.x,this.position.y,this._on?this.onState:this.offState),this._on=!this._on}constructor(t,e,s,i){this.onState=t,this.offState=e,this.draw=s,this.restore=i,this._on=!1}}class et{handleEvent(t){const e=`on${t.type.replace(t.type[0],t.type[0].toUpperCase())}`;return this[e]?this[e](t):null}constructor(t,e,s){this.updateFigure=t,this.sketchpad=e,this.terminal=s,this._started=!1}}class st extends et{_drawFigure(){const t=new Set,e=[];for(const{x:s,y:i,cell:o}of this._activeFigure){this.sketchpad.updateAt(s,i,o);const n={x:s,y:i};t.add(T(n)),e.push(n)}for(const e of this._prevDrawTiles)if(!t.has(T(e))){const{x:t,y:s}=e,i=this.terminal.getCell(t,s);this.sketchpad.updateAt(t,s,i)}this._prevDrawTiles=e}constructor(...t){super(...t),this._prevDrawTiles=[]}}class it extends st{onMousedown(t){return this._started=!0,this._start=this._end=Z(t.target),this._activeFigure=this.updateFigure(this._start,this._end,this._activeFigure,this.terminal),this._drawFigure(),null}onMouseover(t){return this._started?(this._end=Z(t.target),this._activeFigure=this.updateFigure(this._start,this._end,this._activeFigure,this.terminal),this._drawFigure(),null):null}onMouseup(t){return this._activeFigure}}class ot extends st{onMousedown(t){return this._started?this.cleanup():(this._started=!0,this._dimensions=this.terminal.dimensions,this._activeFigure=this.updateFigure(),this._start=this._end=Z(t.target),this._cursor=new tt(this._activeFigure.cursorOn,this._activeFigure.cursorOff,this._drawCursor.bind(this),this._restoreCell.bind(this)),this._cursor.set(this._start),console.log("START CURSOR POS: %o",this._start),null)}onKeydown(t){if(!this._started||t.altKey||t.ctrlKey||t.metaKey)return null;switch(t.preventDefault(),t.key){case"Backspace":this._reverseCharacter();break;case"Enter":this._newline();break;case"Escape":return this.cleanup();case" ":this._advanceCharacter(this._cursor.offState.glyphId);break;default:this._advanceCharacter(C.id(t.key))}return null}cleanup(){return this._started?(this._cursor.reset(),this._activeFigure):null}get _isValidPosition(){return this._end.y>=0&&this._end.y<this._dimensions.height}_advanceCharacter(t){!this._isValidPosition||t<0||(this._activeFigure.advance(this._end,t),this._advanceCursor(),this._drawFigure())}_advanceCursor(){let{x:t,y:e}=this._end;++t,t>=this._dimensions.width&&(t=0,++e),this._end={x:t,y:e},e<this._dimensions.height?this._cursor.set(this._end):this._cursor.clear(),console.log("NEW CURSOR POS: %o",this._end)}_reverseCharacter(){const t=this._activeFigure.reverse();t&&(this._end={x:t.x,y:t.y},this._cursor.reset(this._end)),console.log("REVERSE CURSOR POS: %o",this._end)}_newline(){this._activeFigure.newline(this._end);let t=this._end.y+1;t<this._dimensions.height&&(this._end={x:this._start.x,y:t},this._cursor.reset(this._end)),console.log("NL CURSOR POS: %o",this._end)}_drawCursor(t,e,s){this.sketchpad.updateAt(t,e,s)}_restoreCell(t){const e=this.terminal.getCell(t.x,t.y);this.sketchpad.updateAt(t.x,t.y,e)}}class nt extends et{onMouseup(t){this._started=!0,t.stopPropagation();const e=Z(t.target);return Number.isNaN(e.x)||Number.isNaN(e.y)||this.sketchpad.commitCellSampling(this.terminal.getCell(e.x,e.y)),this.updateFigure()}}class rt{forward(t,e){return this._gesture||(this._gesture=this._createGesture(t)),this._gesture.handleEvent(e)}committed(t){this._gesture=null}cleanup(t){return this.committed(t),null}_createGesture(t){return new this.gestureCls(((t,e,s,i)=>this.figure(this.models.lettertype.cell,t,e,s,i)),t,this.models.terminal)}constructor(t,e,s){this.models=t,this.gestureCls=e,this.figure=s}}class lt extends rt{forward(t,e){const s=super.forward(t,e);return s&&(this._pendingGesture=this._createGesture(t),this._pendingGesture.handleEvent(e)),s}committed(t){this._gesture=this._pendingGesture,this._pendingGesture=null}cleanup(t){const e=this._gesture.cleanup();return this._gesture=this._pendingGesture=null,e}constructor(t){super(t,ot,Q)}}class ht extends rt{constructor(t){super(t,nt,(()=>[]))}}const dt={point:{name:"Single Cell",make:t=>new rt(t,it,P)},brush:{name:"Free Draw",make:t=>new rt(t,it,W)},boxBrush:{name:"Box Draw",make:t=>new rt(t,it,V)},fill:{name:"Fill",make:t=>new rt(t,it,j)},rect:{name:"Rectangle",make:t=>new rt(t,it,$)},fillRect:{name:"Filled Rectangle",make:t=>new rt(t,it,U)},boxRect:{name:"Box Rectangle",make:t=>new rt(t,it,q)},ellipse:{name:"Ellipse",make:t=>new rt(t,it,K)},fillEllipse:{name:"Filled Ellipse",make:t=>new rt(t,it,Y)},line:{name:"Line",make:t=>new rt(t,it,J)},text:{name:"Text",make:t=>new lt(t)},swap:{name:"Replace",make:t=>new rt(t,it,X)},eyedrop:{name:"Eyedrop",make:t=>new ht(t)}},ct=Object.fromEntries(Object.entries(dt).map((([t,e])=>[t,e.name]))),at=Object.fromEntries(Object.keys(dt).map((t=>[t,t])));function ut(t){return ct[t]}function _t(t){const e=dt[t.currentTool];if(!e)throw new Error(`Unknown tool: ${t.currentTool}`);return e.make(t)}function gt(t,e){return{event:t,...e}}const pt={commitDraw:(t,s,i=!1)=>()=>(t.terminal.update(s),gt(e.onDrawCommitted,{figure:s,cleanup:i})),checkResizeTerminal:(t,s)=>()=>{const i=t.terminal.dimensions;return gt(s.columns<i.width||s.rows<i.height?e.onTerminalResizeVerify:e.onTerminalResizeReady,{dims:s})},commitResizeTerminal:(t,s)=>()=>(console.log("resized terminal: %o",s),t.terminal.resize(s.columns,s.rows),t.lettertype.fontSize=s.fontSize,gt(e.onTerminalResized,{terminal:t.terminal,fontSize:s.fontSize})),setBackgroundColor:(t,s)=>()=>(t.lettertype.cell.bgColorId=s,gt(e.onBackgroundColorChanged,{colorId:s})),setForegroundColor:(t,s)=>()=>(t.lettertype.cell.fgColorId=s,gt(e.onForegroundColorChanged,{colorId:s})),setGlyph:(t,s)=>()=>(t.lettertype.cell.glyphId=s,gt(e.onGlyphChanged,{glyphId:s})),setTool:(t,s)=>()=>(t.currentTool=s,gt(e.onToolChanged,{tool:_t(t),name:s}))},mt=Object.fromEntries(Object.keys(pt).map((t=>[t,t])));class ft{command(t,...e){const s=this._commands[t];if(!s)throw new Error(`Unknown command: ${t}`);const i=s(...e)();this.notifier.signal(i)}_bindCommands(t){this._commands=Object.fromEntries(Object.entries(pt).map((([e,s])=>[e,(...e)=>s(t,...e)])))}constructor(t,e){this.notifier=t,this._bindCommands(e)}}class yt{get dimensions(){return{width:this._stride,height:this._height}}resize(t,e){if(t<1||t>65536||e<1||e>65536){throw new Error(`Terminal dimensions must be in range [1, 65536]; got arguments {columns: ${t}, rows: ${e}}`)}if(t===this._stride&&e===this._height)return;const s=this._newCellGrid(t,e);this._stride=t,this._height=e,this._cells=s}getCell(t,e){const s=t+e*this._stride;return this._cells[s]}updateCell(t,e,s){this.getCell(t,e).update(s)}update(t){for(const{x:e,y:s,cell:i}of t)this.updateCell(e,s,i)}_newCellGrid(t,e){const s=[],i=Math.trunc((this._stride-t)/2),o=Math.trunc((this._height-e)/2);for(let n=0;n<e;++n)for(let e=0;e<t;++e){const t=e+i,r=n+o,l=this._getResizeAdjustedCell(t,r);s.push(null!=l?l:new v)}return s}_getResizeAdjustedCell(t,e){return t>=0&&t<this._stride&&e>=0&&e<this._height?this.getCell(t,e):null}constructor(t,e){this._stride=this._height=0,this.resize(t,e)}}var Ct={load:()=>({currentTool:at.brush,lettertype:{cell:new v(C.SIGILS.DEFAULT),fontSize:20},terminal:new yt(80,25)})};class It{constructor(t,e){this.doc=t,this.dispatch=e}}function bt(t){return!0}function wt(t){return g(t)}class xt extends It{draw(t){this._setColor(this.colorInitializer(t.colors)),this._selection.addEventListener("click",(t=>this.onSelected(this)))}subscribe(t){t.subscribe(this.refreshEvent,this._refreshColor.bind(this))}select(){this._selection.classList.add("selected")}deselect(){this._selection.classList.remove("selected")}pick(t){this.dispatch.command(this.cmd,t)}_refreshColor(t){this._setColor(t.colorId)}_setColor(t){this._selection.style.backgroundColor=x.cssColor(t),this._selection.title=x.name(t)}constructor(t,e,s,i,o,...n){super(...n),this._selection=this.doc.getElementById(t),this.cmd=e,this.refreshEvent=s,this.onSelected=i,this.colorInitializer=o}}const vt=[class extends It{draw(t){for(const[t,e]of x.enumerate()){const s=this.doc.createElement("div");s.className="palette-cell",s.dataset.id=t,s.title=x.name(t),s.style.backgroundColor=e,s.addEventListener("click",this._pickColor.bind(this)),this._palette.appendChild(s)}for(const e of this._colorSelections)e.draw(t);this._setSelection(this._colorSelections[0])}subscribe(t){for(const e of this._colorSelections)e.subscribe(t)}_setSelection(t){for(const t of this._colorSelections)t.deselect();t.select(),this._currentSelection=t}_pickColor(t){const e=parseInt(t.target.dataset.id,10);this._currentSelection.pick(e)}constructor(...t){super(...t),this._palette=this.doc.getElementById("palette");const s=this._setSelection.bind(this);this._colorSelections=[new xt("fg-color",mt.setForegroundColor,e.onForegroundColorChanged,s,(t=>t.fg),...t),new xt("bg-color",mt.setBackgroundColor,e.onBackgroundColorChanged,s,(t=>t.bg),...t)]}},class extends It{draw(t){for(const[e,s]of C.enumerate()){const i=this.doc.createElement("span");i.dataset.id=e,i.textContent=s;const o=this.doc.createElement("div");o.appendChild(i),e===t.glyphId&&(o.className="selected",this._selectedBlock=o),o.addEventListener("click",this._pickGlyph.bind(this)),this._block.appendChild(o)}}subscribe(t){t.subscribe(e.onGlyphChanged,this._refreshGlyph.bind(this)),t.subscribe(e.onToolChanged,this._updateSelectionMode.bind(this))}_refreshGlyph(t){const e=t.glyphId;this._selectable===wt?this._lastBoxGlyph=e:(this._lastGlyph=e,g(e)&&(this._lastBoxGlyph=e));for(const t of this._block.children)if(t.firstElementChild.dataset.id===e.toString()){this._selectedBlock.classList.remove("selected"),t.className="selected",this._selectedBlock=t;break}}_updateSelectionMode(t){let e,s;var i,o;t.name.startsWith("box")?(s=wt,e=null!==(i=this._lastBoxGlyph)&&void 0!==i?i:f):(s=bt,e=null!==(o=this._lastGlyph)&&void 0!==o?o:C.SIGILS.DEFAULT);s!==this._selectable&&(this._selectable=s,this._applySelectionPredicate(),g(this._lastGlyph)||this.dispatch.command(mt.setGlyph,e))}_pickGlyph(t){const e=t.target;if(e.classList.contains("disabled"))t.preventDefault();else{const t=parseInt(e.firstElementChild.dataset.id,10);this.dispatch.command(mt.setGlyph,t)}}_applySelectionPredicate(){for(const t of this._block.children)this._selectable(t.firstElementChild.dataset.id)?t.classList.remove("disabled"):t.classList.add("disabled")}constructor(...t){super(...t),this._block=this.doc.getElementById("letter-block"),this._selectable=bt}},class extends It{get fontSize(){return parseInt(this._inputControls[0].value,10)}get columns(){return parseInt(this._inputControls[1].value,10)}get rows(){return parseInt(this._inputControls[2].value,10)}draw(t){const e=t.terminal.dimensions;[t.fontSize,e.width,e.height].forEach(((t,e)=>{const s=this._inputControls[e];s.dataset.currentValue=s.value=t}));for(const t of this._inputControls)t.addEventListener("input",this._updateButton.bind(this));this._form.addEventListener("submit",this._updateSketchpadDims.bind(this))}subscribe(t){t.subscribe(e.onTerminalResizeVerify,this._verifyResize.bind(this)),t.subscribe(e.onTerminalResizeReady,this._commitResize.bind(this))}_updateSketchpadDims(t){t.preventDefault();const e={fontSize:this.fontSize,columns:this.columns,rows:this.rows};this.dispatch.command(mt.checkResizeTerminal,e)}_verifyResize(t){if(this.doc.defaultView.confirm("Reducing the drawing size may discard portions of your current sketch. Continue?"))this._commitResize(t);else{for(const t of this._inputControls)t.value=t.dataset.currentValue;this._updateButton()}}_commitResize(t){for(const t of this._inputControls)t.dataset.currentValue=t.value;this._updateButton(),this.dispatch.command(mt.commitResizeTerminal,t.dims)}_updateButton(){this._button.disabled=this._inputControls.every((t=>t.value===t.dataset.currentValue))}constructor(...t){super(...t),this._form=this.doc.getElementById("sketchpad-controls"),this._button=this._form.querySelector("button"),this._inputControls=[this.doc.getElementById("font-size"),this.doc.getElementById("column-count"),this.doc.getElementById("row-count")]}},class extends It{draw(t){this._tool=t.tool,this._drawSketchpad(t.terminal,t.fontSize),this.doc.addEventListener("mouseup",this._handleGesture.bind(this)),this.doc.addEventListener("keydown",this._handleGesture.bind(this))}subscribe(t){t.subscribe(e.onDrawCommitted,this._committed.bind(this)),t.subscribe(e.onToolChanged,this._updateTool.bind(this)),t.subscribe(e.onTerminalResized,this._resizeSketchpad.bind(this))}updateAt(t,e,s){const i=t+e*this._stride,o=this._grid[i];if(!o)return void console.warn("Invalid grid index %d: (%d, %d)",i,t,e);const n=o.firstChild;n.textContent=C.glyph(s.glyphId),n.style.color=x.cssColor(s.fgColorId),n.style.backgroundColor=x.cssColor(s.bgColorId)}commitCellSampling(t){this.dispatch.command(mt.setForegroundColor,t.fgColorId),this.dispatch.command(mt.setBackgroundColor,t.bgColorId),this.dispatch.command(mt.setGlyph,t.glyphId)}_drawSketchpad(t,e){const s=this._measureGlyph(e),i=t.dimensions;this._stride=i.width,console.log("Tilesize: %o",s),console.log("TermSize: %o",i);const o=this._sketchpad.style;o.fontSize=`${e}px`,o.width=i.width*s.width+"px",o.height=i.height*s.height+"px",o.gridTemplateColumns=`repeat(${i.width}, 1fr)`;const n=`${s.width}px`,r=`${s.height}px`,l=["mousedown","mouseover","mouseup"];for(this._grid.length=0;this._sketchpad.firstChild;)this._sketchpad.removeChild(this._sketchpad.firstChild);for(let e=0;e<i.height;++e)for(let s=0;s<i.width;++s){const i=this.doc.createElement("div");i.appendChild(this.doc.createElement("span")),i.style.width=n,i.style.height=r,i.dataset.x=s,i.dataset.y=e;for(const t of l)i.addEventListener(t,this._handleGesture.bind(this));this._grid.push(i),this._sketchpad.appendChild(i),this.updateAt(s,e,t.getCell(s,e))}}_measureGlyph(t){this._ruler.style.fontSize=`${t}px`;let e={minWidth:100,maxWidth:0,minHeight:100,maxHeight:0};e=[...C.glyphs()].reduce(((t,e)=>{this._ruler.textContent=e;const{width:s,height:i}=this._ruler.getBoundingClientRect();return{minWidth:Math.min(t.minWidth,s||t.minWidth),maxWidth:Math.max(t.maxWidth,s),minHeight:Math.min(t.minHeight,i||t.minHeight),maxHeight:Math.max(t.maxHeight,i)}}),e),this._ruler.textContent=C.glyph(C.SIGILS.DEFAULT);const{width:s,height:i}=this._ruler.getBoundingClientRect();return console.log("Font dims: %o",e),console.log("Bounding rect: %o",{width:s,height:i}),{width:Math.floor(s),height:Math.floor(i)}}_handleGesture(t){const e=this._tool.forward(this,t);e&&(this.dispatch.command(mt.commitDraw,e),console.log("generated figure: %o",e))}_committed(t){t.cleanup||(console.log("commit figure"),this._tool.committed(t))}_updateTool(t){const e=this._tool.cleanup();e&&(this.dispatch.command(mt.commitDraw,e,!0),console.log("got cleanup figure: %o",e)),this._tool=t.tool}_resizeSketchpad(t){this._drawSketchpad(t.terminal,t.fontSize)}constructor(...t){super(...t),this._ruler=this.doc.getElementById("glyph-ruler"),this._sketchpad=this.doc.getElementById("sketchpad"),this._grid=[],this._stride=0}},class extends It{draw(t){for(const e of Object.values(at)){const s=this.doc.createElement("input");s.type="radio",s.id=`tool-selection-${e}`,s.name="tool-selection",s.value=e,s.checked=e===t.toolName,s.addEventListener("input",this._pickTool.bind(this));const i=this.doc.createElement("label");i.htmlFor=s.id,i.title=ut(e),i.className=`tool-${e}`,this._toolSelector.appendChild(s),this._toolSelector.appendChild(i),this._toolSelections.push(s)}}subscribe(t){t.subscribe(e.onToolChanged,this._refreshTool.bind(this))}_pickTool(t){this.dispatch.command(mt.setTool,t.target.value)}_refreshTool(t){for(const e of this._toolSelections)e.checked=e.value===t.name}constructor(...t){super(...t),this._toolSelector=this.doc.getElementById("tool-selections"),this._toolSelections=[]}}];class St{initialize(){this._createModels(),this._wireCommands(),this._createViews(),this._registerViews(),this._drawViews(),console.log("started letter-sketch")}_createModels(){this._models=Ct.load()}_wireCommands(){this._dispatch=new ft(this._notifier,this._models)}_createViews(){this._views=vt.map((t=>new t(this._doc,this._dispatch)))}_registerViews(){this._notifier.register(...this._views)}_drawViews(){const t=this._initialState();for(const e of this._views)e.draw(t)}_initialState(){return{colors:{bg:this._models.lettertype.cell.bgColorId,fg:this._models.lettertype.cell.fgColorId},fontSize:this._models.lettertype.fontSize,glyphId:this._models.lettertype.cell.glyphId,terminal:this._models.terminal,tool:_t(this._models),toolName:this._models.currentTool}}constructor(t){this.win=t,this._doc=t.document,this._notifier=new s}}t.lettersketch=function(){let t;return{start(e){t=new St(e),t.initialize()}}}();
//# sourceMappingURL=index.ad8f2af3.js.map
